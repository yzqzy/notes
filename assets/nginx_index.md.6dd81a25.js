import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.9bc09dc8.js";const p="/assets/view.d39eed92.png",o="/assets/mainline.999e0c6e.png",e="/assets/version.f3a02e27.png",t="/assets/openresty.af546e4d.png",r="/assets/contents.5973aeb8.png",c="/assets/configura.3dc973bf.png",i="/assets/contents02.8fad7652.png",E="/assets/install.643e62c9.png",y="/assets/SSL.580002fe.png",d="/assets/TLS.62dff575.png",h="/assets/tls_secret_01.754d59fc.png",u="/assets/tls_secret_02.3f04e942.png",g="/assets/tls_secret_03.eb68d7cc.png",_="/assets/pki.a7604f71.png",m="/assets/domain.e16e1ef2.png",F="/assets/domain_02.99eb44f7.png",b="/assets/tls_connection.cca19f8f.png",x="/assets/tls_nginx.d6bd52fd.png",v="/assets/tls_nginx_02.22e40dc7.png",k="/assets/tls_nginx_03.7ef73216.png",f="/assets/request.b7829247.png",A="/assets/nginx_model.da8177a3.png",D="/assets/nginx_sign.7cdf1187.png",C="/assets/nginx_reload.df69de3c.png",q="/assets/nginx_reload02.eda989a6.png",B="/assets/nginx_upgrade.29c42e7c.png",P="/assets/nginx_upgrade02.539c9420.png",z="/assets/nginx_reload03.a954372e.png",w="/assets/network.1ba61d58.png",$="/assets/tcp.57d9db8b.png",T="/assets/interface.cb45a937.png",j="/assets/nginx_loop.7bb3915a.png",N="/assets/epoll.d8d3b7f8.png",S="/assets/request_switch.da18dcf1.png",H="/assets/nginx_sleep.c19d3988.png",R="/assets/nginx_no_sleep.5784dbbf.png",I="/assets/nginx_no_sleep02.0fd89cd0.png",U="/assets/modules_def.c8be54b5.png",L="/assets/modules_cates.04b99755.png",O="/assets/direction_context.e32ee024.png",X="/assets/direction_merge.969a67cf.png",G="/assets/direction_merge_rule01.50041bf0.png",M="/assets/direction_merge_rule02.613d8f64.png",W="/assets/nginx_listen.7823957d.png",K="/assets/request_module.e94fc36c.png",V="/assets/request_module02.553e395f.png",Z="/assets/reg01.77d6b9ac.png",Q="/assets/reg02.7481226c.png",Y="/assets/nginx_request01.6da3f064.png",J="/assets/nginx_request02.f62ff0ff.png",ss="/assets/src_ip.9015500f.png",as="/assets/direction_realip.ec5e7df7.png",ns="/assets/nginx_rewrite.43efd7e4.png",ls="/assets/nginx_error_page.82cb1797.png",ps="/assets/nginx_rewrite02.d4173aa5.png",os="/assets/nginx_error_log.a9dde9df.png",es="/assets/nginx_if.efc999f4.png",ts="/assets/nginx_location.a966cf87.png",rs="/assets/nginx_location02.31c866d2.png",cs="/assets/nginx_limit_conn.a34302b2.png",is="/assets/nginx_limit_req.0ad884cc.png",Es="/assets/access_allow.614272b3.png",ys="/assets/rfc2617.77822868.png",ds="/assets/access_auth_basic.08749bb6.png",hs="/assets/access_request.6bb3e117.png",us="/assets/access_satisfy.c00136cc.png",gs="/assets/precontent_try_files.83528f0e.png",_s="/assets/precontent_mirror.7e87a1bd.png",ms="/assets/content_root_alias.fad5c7e4.png",Fs="/assets/content_content_type.ee7ab6ef.png",bs="/assets/content_no_log.918d8b72.png",xs="/assets/content_redirect.ed25b43e.png",vs="/assets/content_index.d43c472c.png",ks="/assets/content_auto_index01.d6e6fab7.png",fs="/assets/content_auto_index02.72f8172c.png",As="/assets/content_concat.9299e684.png",Ds="/assets/content_concat02.7aa6ea86.png",Cs="/assets/log.d077fefc.png",qs="/assets/log02.802991a0.png",Bs="/assets/log03.121d52a5.png",Ps="/assets/filter.2929e933.png",zs="/assets/filter02.c7340a4e.png",ws="/assets/filter_sub.336c7c81.png",$s="/assets/filter_sub02.4aeee997.png",Ts="/assets/filter_addition.5e1b335b.png",js="/assets/filter_addition02.37a8ee4e.png",Ns="/assets/var01.835d6cc1.png",Ss="/assets/referer_module.f79d4e8b.png",Hs="/assets/referer_module02.c1162a7d.png",Rs="/assets/secure_link.1805bcd5.png",Is="/assets/secure_link02.5e225e2f.png",Us="/assets/secure_link03.09fa0982.png",Ls="/assets/secure_link04.db93aa71.png",Os="/assets/map.1245c835.png",Xs="/assets/map03.6fbb6b48.png",Gs="/assets/map02.713c10fb.png",Ms="/assets/split_clients.d980fdee.png",Ws="/assets/split_clients02.f93bb0cf.png",Ks="/assets/geo.1e01c337.png",Vs="/assets/geo02.3b6ef0a0.png",Zs="/assets/geoip.4948d343.png",Qs="/assets/geoip02.197e76f5.png",Ys="/assets/geoip03.434e0cfb.png",Js="/assets/geoip04.87c99856.png",sa="/assets/keepalive.cccff3f6.png",aa="/assets/keepalive02.b86fbd46.png",na="/assets/banlance.1aad4231.png",la="/assets/nginx.42f92a3c.png",pa="/assets/nginx02.499eef1a.png",oa="/assets/nginx03.1e319263.png",ea="/assets/upstream.b8191cbb.png",ta="/assets/upstream02.118409fc.png",ra="/assets/upstream03.b3aec391.png",ca="/assets/keepalive03.7dccb8a6.png",ia="/assets/keepalive04.6dd448da.png",Ea="/assets/keepalive05.02fbf882.png",ya="/assets/upstream_ip_hash.0fc50fba.png",da="/assets/upstream_hash.4074d268.png",ha="/assets/upstream_hash_error.5fbc9ca6.png",ua="/assets/upstream_hash_error02.a1a3071c.png",ga="/assets/upstream_hash_before.0d204815.png",_a="/assets/upstream_hash_after.4ba688ff.png",ma="/assets/upstream_hash02.92763790.png",Fa="/assets/upstream_least_conn.8264115f.png",ba="/assets/upstream_zone.d52902eb.png",xa="/assets/upstream_order.0fc652b7.png",va="/assets/proxy_pass.39c6aef5.png",ka="/assets/proxy_pass02.f76f878b.png",fa="/assets/proxy_pass03.686d00f3.png",Aa="/assets/proxy_pass04.dcfe3cd6.png",Da="/assets/proxy_pass05.2d3a8d87.png",Ca="/assets/proxy_pass06.7ef6eb9e.png",qa="/assets/receive.81919c01.png",Ba="/assets/receive02.7d73aa7e.png",Pa="/assets/receive03.850fdf31.png",za="/assets/receive04.653d8948.png",wa="/assets/receive05.e97755d0.png",$a="/assets/up_server.9dcc230f.png",Ta="/assets/up_server02.926ee154.png",ja="/assets/up_server03.174d5f4e.png",Na="/assets/up_server04.7cb2d7a2.png",Sa="/assets/up_server05.954c900c.png",Ha="/assets/http_receive.811a9ea6.png",Ra="/assets/http_receive02.94d0b60f.png",Ia="/assets/http_receive03.66d1df00.png",Ua="/assets/http_receive04.4f50bea6.png",La="/assets/http_receive05.fe8ab601.png",Oa="/assets/http_receive06.1c39c4ed.png",an=JSON.parse('{"title":"Nginx 核心知识","description":"","frontmatter":{},"headers":[],"relativePath":"nginx/index.md","filePath":"nginx/index.md"}'),Xa={name:"nginx/index.md"},Ga=l('<h1 id="nginx-核心知识" tabindex="-1">Nginx 核心知识 <a class="header-anchor" href="#nginx-核心知识" aria-label="Permalink to &quot;Nginx 核心知识&quot;">​</a></h1><h2 id="一、nginx-基础" tabindex="-1">一、Nginx 基础 <a class="header-anchor" href="#一、nginx-基础" aria-label="Permalink to &quot;一、Nginx 基础&quot;">​</a></h2><h3 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-label="Permalink to &quot;概述&quot;">​</a></h3><h4 id="主流-web-服务器" tabindex="-1">主流 Web 服务器 <a class="header-anchor" href="#主流-web-服务器" aria-label="Permalink to &quot;主流 Web 服务器&quot;">​</a></h4><p>Nginx、Apache、Tomcat。</p><h4 id="nginx-的优点" tabindex="-1">Nginx 的优点 <a class="header-anchor" href="#nginx-的优点" aria-label="Permalink to &quot;Nginx 的优点&quot;">​</a></h4><p>2014 发展至今。</p><ul><li>高并发，高性能</li><li>可扩展性好</li><li>高可靠性</li><li>热部署</li><li>BSD 许可证</li></ul><h3 id="nginx-应用场景" tabindex="-1">Nginx 应用场景 <a class="header-anchor" href="#nginx-应用场景" aria-label="Permalink to &quot;Nginx 应用场景&quot;">​</a></h3><ul><li>静态资源托管 <ul><li>通过本地文件系统提供服务</li></ul></li><li>反向代理服务 <ul><li>Nginx 的强大功能</li><li>缓存</li><li>负载均衡</li></ul></li><li>API 服务 <ul><li>OpenResty</li></ul></li></ul><img src="'+p+'" style="zoom:80%;"><h3 id="nginx-历史背景" tabindex="-1">Nginx 历史背景 <a class="header-anchor" href="#nginx-历史背景" aria-label="Permalink to &quot;Nginx 历史背景&quot;">​</a></h3><ul><li>互联网的数据量快速增长 <ul><li>互联网的快速普及</li><li>全球化</li><li>物联网</li></ul></li><li>摩尔定律：性能提升</li><li>低效的 Apache <ul><li>一个连接对应一个进程</li></ul></li></ul><h3 id="nginx-优点" tabindex="-1">Nginx 优点 <a class="header-anchor" href="#nginx-优点" aria-label="Permalink to &quot;Nginx 优点&quot;">​</a></h3><ul><li>高并发，高性能</li><li>可扩展性好</li><li>高可靠性</li><li>热部署</li><li>BSD 许可证</li></ul><h3 id="nginx-组成部分" tabindex="-1">Nginx 组成部分 <a class="header-anchor" href="#nginx-组成部分" aria-label="Permalink to &quot;Nginx 组成部分&quot;">​</a></h3><ul><li>Nginx 二进制可执行文件 <ul><li>由各模块源码编译出的一个文件</li></ul></li><li>Nginx.conf 配置文件 <ul><li>控制 Nginx 的行为</li></ul></li><li>access.log 访问日志 <ul><li>记录每一条 http 请求信息</li></ul></li><li>error.log 错误日志 <ul><li>定位问题</li></ul></li></ul><h3 id="nginx-版本发布历史" tabindex="-1">Nginx 版本发布历史 <a class="header-anchor" href="#nginx-版本发布历史" aria-label="Permalink to &quot;Nginx 版本发布历史&quot;">​</a></h3><p>nginx 版本发布情况（mainline）。2002 年开发时间，2004 推出第一个版本。</p><img src="'+o+'" style="zoom:80%;"><p><a href="https://nginx.org/en/download.html%E3%80%82" target="_blank" rel="noreferrer">https://nginx.org/en/download.html。</a></p><h3 id="nginx-发行版本选择" tabindex="-1">Nginx 发行版本选择 <a class="header-anchor" href="#nginx-发行版本选择" aria-label="Permalink to &quot;Nginx 发行版本选择&quot;">​</a></h3><p>开源免费的 Nginx 与商业版 Nginx Plus。</p><p>开源版：nginx.org</p><p>商业版：nginx.com</p><img src="'+e+'" style="zoom:80%;"><p>阿里巴巴的 Tengine，<a href="http://tengine.taobao.org/%E3%80%82" target="_blank" rel="noreferrer">http://tengine.taobao.org/。</a></p><blockquote><p>Tengine是由淘宝网发起的Web服务器项目。它在<a href="http://nginx.org/" target="_blank" rel="noreferrer">Nginx</a>的基础上，针对大访问量网站的需求，添加了很多高级功能和特性。Tengine的性能和稳定性已经在大型的网站如<a href="http://www.taobao.com/" target="_blank" rel="noreferrer">淘宝网</a>，<a href="http://www.tmall.com/" target="_blank" rel="noreferrer">天猫商城</a>等得到了很好的检验。它的最终目标是打造一个高效、稳定、安全、易用的Web平台。</p><p>从2011年12月开始，Tengine成为一个开源项目，Tengine团队在积极地开发和维护着它。Tengine团队的核心成员来自于<a href="http://www.taobao.com/" target="_blank" rel="noreferrer">淘宝</a>、<a href="http://www.sogou.com/" target="_blank" rel="noreferrer">搜狗</a>等互联网企业。Tengine是社区合作的成果，我们欢迎大家<a href="http://tengine.taobao.org/source_cn.html" target="_blank" rel="noreferrer">参与其中</a>，贡献自己的力量。</p></blockquote><p>免费 OpenResty 与商业版 OpenRestry</p><p>开源 OpenRestry：<a href="http://openresty.org" target="_blank" rel="noreferrer">http://openresty.org</a>。</p><blockquote><p>OpenResty® 是一个基于 <a href="http://openresty.org/cn/nginx.html" target="_blank" rel="noreferrer">Nginx</a> 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p><p>OpenResty® 通过汇聚各种设计精良的 <a href="http://openresty.org/cn/nginx.html" target="_blank" rel="noreferrer">Nginx</a> 模块（主要由 OpenResty 团队自主开发），从而将 <a href="http://openresty.org/cn/nginx.html" target="_blank" rel="noreferrer">Nginx</a> 有效地变成一个强大的通用 Web 应用平台。这样，Web 开发人员和系统工程师可以使用 Lua 脚本语言调动 <a href="http://openresty.org/cn/nginx.html" target="_blank" rel="noreferrer">Nginx</a> 支持的各种 C 以及 Lua 模块，快速构造出足以胜任 10K 乃至 1000K 以上单机并发连接的高性能 Web 应用系统。</p></blockquote><p>商业版 OpenResty：<a href="https://openresty.com" target="_blank" rel="noreferrer">https://openresty.com</a>。</p><blockquote><p>技术支持比较好。</p></blockquote><img src="'+t+`" style="zoom:100%;"><h3 id="编译适合自己的-nginx" tabindex="-1">编译适合自己的 Nginx <a class="header-anchor" href="#编译适合自己的-nginx" aria-label="Permalink to &quot;编译适合自己的 Nginx&quot;">​</a></h3><h4 id="下载-nginx" tabindex="-1">下载 Nginx <a class="header-anchor" href="#下载-nginx" aria-label="Permalink to &quot;下载 Nginx&quot;">​</a></h4><p><a href="https://nginx.org" target="_blank" rel="noreferrer">https://nginx.org</a></p><p>download</p><p>Mainline version、Stable version</p><p>下载稳定版。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">wget </span><span style="color:#B392F0;">https</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//nginx.org/download/nginx-1.20.1.tar.gz</span></span>
<span class="line"><span style="color:#E1E4E8;">tar </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">xzf nginx</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1.20</span><span style="color:#E1E4E8;">.1.tar.gz</span></span>
<span class="line"><span style="color:#E1E4E8;">cd nginx</span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1.20</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">wget </span><span style="color:#6F42C1;">https</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//nginx.org/download/nginx-1.20.1.tar.gz</span></span>
<span class="line"><span style="color:#24292E;">tar </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">xzf nginx</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1.20</span><span style="color:#24292E;">.1.tar.gz</span></span>
<span class="line"><span style="color:#24292E;">cd nginx</span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1.20</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">1</span></span></code></pre></div><h4 id="目录介绍" tabindex="-1">目录介绍 <a class="header-anchor" href="#目录介绍" aria-label="Permalink to &quot;目录介绍&quot;">​</a></h4><img src="`+r+'"><ul><li>auto <ul><li>cc 编译</li><li>lib</li><li>os</li><li>types</li></ul></li><li>CHANGES：Nginx 每个版本中提供提供的特性和修复的 BUG</li><li>CHANGES.ru：俄罗斯版本的 CHANGEES 文件，作者是俄罗斯的</li><li>conf 示例文件</li><li>configure：脚本，生成中间文件，执行编译前的必备动作</li><li>contrib：提供脚本和 VIM 工具 <ul><li>cp -r contrib/vim/* ～/.vim/ 可以使 vim 支持 nginx 语法</li></ul></li><li>html：提供标准 HTML 文件，500 错误文件与默认 nginx 欢迎界面</li><li>main：linux 对 nginx 的帮助文件</li><li>src：Nginx 源代码</li></ul><h4 id="configure" tabindex="-1">Configure <a class="header-anchor" href="#configure" aria-label="Permalink to &quot;Configure&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">configure </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">help </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> more </span><span style="color:#6A737D;">// 查看帮助文件</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">.</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">configure </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">help </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> more </span><span style="color:#6A737D;">// 查看帮助文件</span></span></code></pre></div><p>默认参数编译</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">configure </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">prefix</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">data</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">.</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">configure </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">prefix</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">data</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span></span></code></pre></div><img src="'+c+'"><h4 id="中间文件介绍" tabindex="-1">中间文件介绍 <a class="header-anchor" href="#中间文件介绍" aria-label="Permalink to &quot;中间文件介绍&quot;">​</a></h4><img src="'+i+'"><p>objs</p><ul><li><p>ngx_modules.c：决定 nginx 编译时有哪些模块会被编译进 nginx</p></li><li><p>src</p></li></ul><h4 id="编译" tabindex="-1">编译 <a class="header-anchor" href="#编译" aria-label="Permalink to &quot;编译&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">make </span><span style="color:#6A737D;">// 编译</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">make </span><span style="color:#6A737D;">// 编译</span></span></code></pre></div><p>编译结束后，会在 objs 目录下生成大量二进制文件。</p><blockquote><p>c 语言编译时生成的所有的中间文件都会放到 src 目录</p></blockquote><p>nginx 版本升级时，需要将 objs 目录下的文件拷贝到安装目录中。</p><p>如果我们使用动态模块，动态模块会生成 so 动态文件，也会放到 objs 目录下。</p><h4 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">make install </span><span style="color:#6A737D;">// 首次安装时可以使用此命令</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">make install </span><span style="color:#6A737D;">// 首次安装时可以使用此命令</span></span></code></pre></div><p>安装完成后可以去指定目录查看。</p><img src="'+E+`"><p>sbin：nginx 二进制文件</p><p>config：和源代码中配置文件相同，决定 nginx 功能文件</p><p>logs：日志文件</p><h3 id="配置文件的通用语法介绍" tabindex="-1">配置文件的通用语法介绍 <a class="header-anchor" href="#配置文件的通用语法介绍" aria-label="Permalink to &quot;配置文件的通用语法介绍&quot;">​</a></h3><h4 id="基础语法" tabindex="-1">基础语法 <a class="header-anchor" href="#基础语法" aria-label="Permalink to &quot;基础语法&quot;">​</a></h4><ul><li>配置文件由指令与指令块组成</li><li>每条指令以 ；分号结尾，指令与参数间以空格符号分割</li><li>指令块以 {} 大括号将多条指令组织在一起</li><li>include 语句允许组合多个配置文件以提升可维护性</li><li>使用 # 符号添加注释，提高可读性</li><li>使用 $ 符号使用变量</li><li>部分指令的参数支持正则表达式</li></ul><h4 id="配置参数-时间单位" tabindex="-1">配置参数：时间单位 <a class="header-anchor" href="#配置参数-时间单位" aria-label="Permalink to &quot;配置参数：时间单位&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ms milliseconds</span></span>
<span class="line"><span style="color:#E1E4E8;">d days</span></span>
<span class="line"><span style="color:#E1E4E8;">s seconds</span></span>
<span class="line"><span style="color:#E1E4E8;">w weeks</span></span>
<span class="line"><span style="color:#E1E4E8;">m minutes</span></span>
<span class="line"><span style="color:#79B8FF;">M</span><span style="color:#E1E4E8;"> months, </span><span style="color:#79B8FF;">30</span><span style="color:#E1E4E8;"> days</span></span>
<span class="line"><span style="color:#E1E4E8;">h hours</span></span>
<span class="line"><span style="color:#E1E4E8;">y years, </span><span style="color:#79B8FF;">365</span><span style="color:#E1E4E8;"> days</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ms milliseconds</span></span>
<span class="line"><span style="color:#24292E;">d days</span></span>
<span class="line"><span style="color:#24292E;">s seconds</span></span>
<span class="line"><span style="color:#24292E;">w weeks</span></span>
<span class="line"><span style="color:#24292E;">m minutes</span></span>
<span class="line"><span style="color:#005CC5;">M</span><span style="color:#24292E;"> months, </span><span style="color:#005CC5;">30</span><span style="color:#24292E;"> days</span></span>
<span class="line"><span style="color:#24292E;">h hours</span></span>
<span class="line"><span style="color:#24292E;">y years, </span><span style="color:#005CC5;">365</span><span style="color:#24292E;"> days</span></span></code></pre></div><h4 id="配置参数-空间单位" tabindex="-1">配置参数：空间单位 <a class="header-anchor" href="#配置参数-空间单位" aria-label="Permalink to &quot;配置参数：空间单位&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">bytes</span></span>
<span class="line"><span style="color:#E1E4E8;">k</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">K</span><span style="color:#E1E4E8;"> kilobytes</span></span>
<span class="line"><span style="color:#E1E4E8;">m</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">M</span><span style="color:#E1E4E8;"> megabytes</span></span>
<span class="line"><span style="color:#E1E4E8;">g</span><span style="color:#F97583;">/</span><span style="color:#79B8FF;">G</span><span style="color:#E1E4E8;"> gigabytes</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">bytes</span></span>
<span class="line"><span style="color:#24292E;">k</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">K</span><span style="color:#24292E;"> kilobytes</span></span>
<span class="line"><span style="color:#24292E;">m</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">M</span><span style="color:#24292E;"> megabytes</span></span>
<span class="line"><span style="color:#24292E;">g</span><span style="color:#D73A49;">/</span><span style="color:#005CC5;">G</span><span style="color:#24292E;"> gigabytes</span></span></code></pre></div><h4 id="http-配置的指令块" tabindex="-1">http 配置的指令块 <a class="header-anchor" href="#http-配置的指令块" aria-label="Permalink to &quot;http 配置的指令块&quot;">​</a></h4><p>http：表示内部所有执行由 http 解析并执行</p><p>server：定义域名或者一组域名</p><p>location：url 表达式</p><p>upstream：上游服务，nginx 需要与 tomcat 等其他服务交互时，我们可以定义 upstream</p><h3 id="命令行-重载、热部署、日志切割" tabindex="-1">命令行：重载、热部署、日志切割 <a class="header-anchor" href="#命令行-重载、热部署、日志切割" aria-label="Permalink to &quot;命令行：重载、热部署、日志切割&quot;">​</a></h3><h4 id="linux-命令行" tabindex="-1">linux 命令行 <a class="header-anchor" href="#linux-命令行" aria-label="Permalink to &quot;linux 命令行&quot;">​</a></h4><ul><li>格式：nginx -s reload</li><li>帮助：-? -h</li><li>使用指定的配置文件：-c</li><li>指定配置指令：-g</li><li>指定运行目录：-p</li><li>发送信号：-s <ul><li>立刻停止服务：stop</li><li>优雅的停止服务：quit</li><li>重载配置文件：reload</li><li>重新开始记录日志文件：reopen</li></ul></li><li>测试配置文件是否有语法错误：-t、-T</li><li>打印 nginx 的版本信息、编译信息等：-v、-V</li></ul><h4 id="重载配置文件" tabindex="-1">重载配置文件 <a class="header-anchor" href="#重载配置文件" aria-label="Permalink to &quot;重载配置文件&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s reload </span><span style="color:#6A737D;">// 不停止服务的情况下，重新载入配置文件</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">.</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s reload </span><span style="color:#6A737D;">// 不停止服务的情况下，重新载入配置文件</span></span></code></pre></div><h4 id="热部署" tabindex="-1">热部署 <a class="header-anchor" href="#热部署" aria-label="Permalink to &quot;热部署&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ps </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ef </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grep nginx </span><span style="color:#6A737D;">// 查看进程状况</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ps </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ef </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grep nginx </span><span style="color:#6A737D;">// 查看进程状况</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 备份现有二进制文件</span></span>
<span class="line"><span style="color:#E1E4E8;">cp nginx nginx.old</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 替换正在运行的二进制文件</span></span>
<span class="line"><span style="color:#E1E4E8;">cp </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">r nginx </span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">data</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">sbin</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">f </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 向 master 进程发送信号</span></span>
<span class="line"><span style="color:#E1E4E8;">kill </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">USR2</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13195</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 向老的进程发送关闭信号（关闭 work 进程，老的 master 进程还可以重新拉起 worker 进程）</span></span>
<span class="line"><span style="color:#E1E4E8;">kill </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">WINCH</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13195</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 备份现有二进制文件</span></span>
<span class="line"><span style="color:#24292E;">cp nginx nginx.old</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 替换正在运行的二进制文件</span></span>
<span class="line"><span style="color:#24292E;">cp </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">r nginx </span><span style="color:#D73A49;">/</span><span style="color:#24292E;">data</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">sbin</span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">f </span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 向 master 进程发送信号</span></span>
<span class="line"><span style="color:#24292E;">kill </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">USR2</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13195</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 向老的进程发送关闭信号（关闭 work 进程，老的 master 进程还可以重新拉起 worker 进程）</span></span>
<span class="line"><span style="color:#24292E;">kill </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">WINCH</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13195</span></span></code></pre></div><h4 id="日志切割" tabindex="-1">日志切割 <a class="header-anchor" href="#日志切割" aria-label="Permalink to &quot;日志切割&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">mv blog.log blog.bak.log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s reopen</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">mv blog.log blog.bak.log</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">.</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s reopen</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// bash 脚本</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">crontab </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">l</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// bash 脚本</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">crontab </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">l</span></span></code></pre></div><h3 id="搭建静态资源-web-服务器" tabindex="-1">搭建静态资源 Web 服务器 <a class="header-anchor" href="#搭建静态资源-web-服务器" aria-label="Permalink to &quot;搭建静态资源 Web 服务器&quot;">​</a></h3><p>ngx_http_gzip_module</p><ul><li>Embeded Variables <ul><li>$gzip_ratio 表示当时使用的压缩比率</li></ul></li></ul><p>autoindex module</p><blockquote><p>当我们访问以 “/” 结尾的 url 时，当我们对应到这个目录中，显示这个目录的结构</p></blockquote><p>ngx_http_core_module</p><ul><li>Embeded Variables <ul><li>$limit_rate 限制响应速度</li><li>$content_length 记录请求头部长度</li><li>。。。</li></ul></li></ul><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8080;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">test.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip </span><span style="color:#E1E4E8;">on; </span><span style="color:#6A737D;"># 压缩</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip_min_length </span><span style="color:#E1E4E8;">1; </span><span style="color:#6A737D;"># 小于多少字节就不再压缩</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip_comp_level </span><span style="color:#E1E4E8;">2; </span><span style="color:#6A737D;"># 压缩级别</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip_types </span><span style="color:#E1E4E8;">text/plain application/X-javascript text/css image/jpeg; </span><span style="color:#6A737D;"># 压缩类型</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">www/project/; </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># / 代表所有请求</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 通常使用 alias，root 会携带路径</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 这里就是说 project 目录下后面的路径和 url 是一一对应的</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> autoindex </span><span style="color:#E1E4E8;">on; </span><span style="color:#6A737D;"># 显示文件结构，当路径是一个文件时</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> set </span><span style="color:#E1E4E8;">$limit_rate </span><span style="color:#79B8FF;">1k</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 限制 nginx 向客户端浏览器发送响应的速度，每秒传输多少字节到浏览器中</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8080;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">test.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip </span><span style="color:#24292E;">on; </span><span style="color:#6A737D;"># 压缩</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip_min_length </span><span style="color:#24292E;">1; </span><span style="color:#6A737D;"># 小于多少字节就不再压缩</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip_comp_level </span><span style="color:#24292E;">2; </span><span style="color:#6A737D;"># 压缩级别</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip_types </span><span style="color:#24292E;">text/plain application/X-javascript text/css image/jpeg; </span><span style="color:#6A737D;"># 压缩类型</span></span>
<span class="line"><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">www/project/; </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># / 代表所有请求</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 通常使用 alias，root 会携带路径</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 这里就是说 project 目录下后面的路径和 url 是一一对应的</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> autoindex </span><span style="color:#24292E;">on; </span><span style="color:#6A737D;"># 显示文件结构，当路径是一个文件时</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> set </span><span style="color:#24292E;">$limit_rate </span><span style="color:#005CC5;">1k</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 限制 nginx 向客户端浏览器发送响应的速度，每秒传输多少字节到浏览器中</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>日志相关</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">http</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 命名 main，方便对不同的 url 或者域名做不同的处理</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> log_format </span><span style="color:#E1E4E8;">main </span><span style="color:#9ECBFF;">&#39;$</span><span style="color:#E1E4E8;">remote_addr</span><span style="color:#9ECBFF;"> - $</span><span style="color:#E1E4E8;">remote_user</span><span style="color:#9ECBFF;"> [$</span><span style="color:#E1E4E8;">time_local</span><span style="color:#9ECBFF;">] &quot;$</span><span style="color:#E1E4E8;">request</span><span style="color:#9ECBFF;">&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">&#39;$</span><span style="color:#E1E4E8;">status</span><span style="color:#9ECBFF;"> $</span><span style="color:#E1E4E8;">body_bytes_sent</span><span style="color:#9ECBFF;"> &quot;$</span><span style="color:#E1E4E8;">http_referer</span><span style="color:#9ECBFF;">&quot; &#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">                  </span><span style="color:#9ECBFF;">&#39;&quot;$</span><span style="color:#E1E4E8;">http_user_agent</span><span style="color:#9ECBFF;">&quot; &quot;$</span><span style="color:#E1E4E8;">http_x_forwarded_for</span><span style="color:#9ECBFF;">&quot;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">http</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 命名 main，方便对不同的 url 或者域名做不同的处理</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> log_format </span><span style="color:#24292E;">main </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">remote_addr</span><span style="color:#032F62;"> - $</span><span style="color:#24292E;">remote_user</span><span style="color:#032F62;"> [$</span><span style="color:#24292E;">time_local</span><span style="color:#032F62;">] &quot;$</span><span style="color:#24292E;">request</span><span style="color:#032F62;">&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">status</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">body_bytes_sent</span><span style="color:#032F62;"> &quot;$</span><span style="color:#24292E;">http_referer</span><span style="color:#032F62;">&quot; &#39;</span></span>
<span class="line"><span style="color:#24292E;">                  </span><span style="color:#032F62;">&#39;&quot;$</span><span style="color:#24292E;">http_user_agent</span><span style="color:#032F62;">&quot; &quot;$</span><span style="color:#24292E;">http_x_forwarded_for</span><span style="color:#032F62;">&quot;&#39;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8080;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">test.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> access_log </span><span style="color:#E1E4E8;">data/logs/test/access.log</span><span style="color:#79B8FF;"> main</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 使用 main 的日志格式，定义输出目录</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip </span><span style="color:#E1E4E8;">on; </span><span style="color:#6A737D;"># 压缩</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip_min_length </span><span style="color:#E1E4E8;">1; </span><span style="color:#6A737D;"># 小于多少字节就不再压缩</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip_comp_level </span><span style="color:#E1E4E8;">2; </span><span style="color:#6A737D;"># 压缩级别</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> gzip_types </span><span style="color:#E1E4E8;">text/plain application/X-javascript text/css image/jpeg; </span><span style="color:#6A737D;"># 压缩类型</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">www/project/; </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># / 代表所有请求</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 通常使用 alias，root 会携带路径</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># 这里就是说 project 目录下后面的路径和 url 是一一对应的</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> autoindex </span><span style="color:#E1E4E8;">on; </span><span style="color:#6A737D;"># 显示文件结构，当路径是一个文件时</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> set </span><span style="color:#E1E4E8;">$limit_rate </span><span style="color:#79B8FF;">1k</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 限制 nginx 向客户端浏览器发送响应的速度，每秒传输多少字节到浏览器中</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8080;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">test.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> access_log </span><span style="color:#24292E;">data/logs/test/access.log</span><span style="color:#005CC5;"> main</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 使用 main 的日志格式，定义输出目录</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip </span><span style="color:#24292E;">on; </span><span style="color:#6A737D;"># 压缩</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip_min_length </span><span style="color:#24292E;">1; </span><span style="color:#6A737D;"># 小于多少字节就不再压缩</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip_comp_level </span><span style="color:#24292E;">2; </span><span style="color:#6A737D;"># 压缩级别</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> gzip_types </span><span style="color:#24292E;">text/plain application/X-javascript text/css image/jpeg; </span><span style="color:#6A737D;"># 压缩类型</span></span>
<span class="line"><span style="color:#24292E;">	</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">www/project/; </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># / 代表所有请求</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 通常使用 alias，root 会携带路径</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># 这里就是说 project 目录下后面的路径和 url 是一一对应的</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> autoindex </span><span style="color:#24292E;">on; </span><span style="color:#6A737D;"># 显示文件结构，当路径是一个文件时</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> set </span><span style="color:#24292E;">$limit_rate </span><span style="color:#005CC5;">1k</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 限制 nginx 向客户端浏览器发送响应的速度，每秒传输多少字节到浏览器中</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="搭建具备缓存功能的反向代理服务" tabindex="-1">搭建具备缓存功能的反向代理服务 <a class="header-anchor" href="#搭建具备缓存功能的反向代理服务" aria-label="Permalink to &quot;搭建具备缓存功能的反向代理服务&quot;">​</a></h3><p>listen 8080</p><p>listen 127.0.0.1:8080 表示只能本机访问 8080 端口</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">127.0.0.1:8080;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">127.0.0.1:8080;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>搭建反向代理服务</p><p>ngx_http_proxy_module</p><ul><li>proxy_cache nginx 性能领先于上游服务器性能，使用 cache 对小的站点会有非常大的性能提升</li></ul><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">http</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 缓存文件相关参数配置</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> proxy_cache_path </span><span style="color:#E1E4E8;">/tmp/nginxcache levels=1:2 keys_zone=my_cache:10m max_size:10g inactive=60m use_temp_path=off; </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">http</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 缓存文件相关参数配置</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> proxy_cache_path </span><span style="color:#24292E;">/tmp/nginxcache levels=1:2 keys_zone=my_cache:10m max_size:10g inactive=60m use_temp_path=off; </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">local </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8080;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">80;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">test.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">Host $host;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">X-Real-IP $remote_addr;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">X-Forwarded-For $proxy_add_x_forwared_for;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_cache </span><span style="color:#E1E4E8;">my_cache;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_cache_key </span><span style="color:#E1E4E8;">$host$uri$is_args$args;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_cache_valid </span><span style="color:#E1E4E8;">200 </span><span style="color:#79B8FF;">304</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">302</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1d</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://local;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }  </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">local </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8080;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">80;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">test.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Host $host;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Real-IP $remote_addr;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Forwarded-For $proxy_add_x_forwared_for;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_cache </span><span style="color:#24292E;">my_cache;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_cache_key </span><span style="color:#24292E;">$host$uri$is_args$args;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_cache_valid </span><span style="color:#24292E;">200 </span><span style="color:#005CC5;">304</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">302</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1d</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://local;</span></span>
<span class="line"><span style="color:#24292E;">  }  </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="goaccess-实现日志可视化" tabindex="-1">GoAccess 实现日志可视化 <a class="header-anchor" href="#goaccess-实现日志可视化" aria-label="Permalink to &quot;GoAccess 实现日志可视化&quot;">​</a></h3><p><a href="https://goaccess.io" target="_blank" rel="noreferrer">https://goaccess.io</a></p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">goaccess access.log </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o report.html </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">log</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">format</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">COMBINED</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">goaccess access.log </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o report.html </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">log</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">format</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">COMBINED</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">goaccess access.log </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">o ..</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">html</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">report.html </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">real</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">time</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">html </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">time</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">format</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;%H:%M:%S&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">date</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">format</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;%d/%b/%Y&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">log</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">format</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">COMBINED</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">goaccess access.log </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">o ..</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">html</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">report.html </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">real</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">time</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">html </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">time</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">format</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;%H:%M:%S&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">date</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">format</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">&#39;%d/%b/%Y&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">log</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">format</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">COMBINED</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#F97583;">	access_log </span><span style="color:#E1E4E8;">logs/access.log</span><span style="color:#79B8FF;"> main</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/report.html </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">/data/log/blog/report.html</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#D73A49;">	access_log </span><span style="color:#24292E;">logs/access.log</span><span style="color:#005CC5;"> main</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/report.html </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">/data/log/blog/report.html</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="从网络原理来看-ssl-安全协议" tabindex="-1">从网络原理来看 SSL 安全协议 <a class="header-anchor" href="#从网络原理来看-ssl-安全协议" aria-label="Permalink to &quot;从网络原理来看 SSL 安全协议&quot;">​</a></h3><img src="`+y+'" style="zoom:80%;"><img src="'+d+'" style="zoom:80%;"><h3 id="对称加密与非对称加密" tabindex="-1">对称加密与非对称加密 <a class="header-anchor" href="#对称加密与非对称加密" aria-label="Permalink to &quot;对称加密与非对称加密&quot;">​</a></h3><h4 id="对称加密" tabindex="-1">对称加密 <a class="header-anchor" href="#对称加密" aria-label="Permalink to &quot;对称加密&quot;">​</a></h4><img src="'+h+'" style="zoom:80%;"><img src="'+u+'" style="zoom:80%;"><h4 id="非对称加密" tabindex="-1">非对称加密 <a class="header-anchor" href="#非对称加密" aria-label="Permalink to &quot;非对称加密&quot;">​</a></h4><img src="'+g+'" style="zoom:80%;"><h3 id="ssl-如何保证公信力" tabindex="-1">SSL 如何保证公信力 <a class="header-anchor" href="#ssl-如何保证公信力" aria-label="Permalink to &quot;SSL 如何保证公信力&quot;">​</a></h3><h4 id="pki-公钥基础设施" tabindex="-1">PKI 公钥基础设施 <a class="header-anchor" href="#pki-公钥基础设施" aria-label="Permalink to &quot;PKI 公钥基础设施&quot;">​</a></h4><img src="'+_+'" style="zoom:100%;"><h4 id="证书类型" tabindex="-1">证书类型 <a class="header-anchor" href="#证书类型" aria-label="Permalink to &quot;证书类型&quot;">​</a></h4><img src="'+m+'" style="zoom:100%;"><h4 id="证书链" tabindex="-1">证书链 <a class="header-anchor" href="#证书链" aria-label="Permalink to &quot;证书链&quot;">​</a></h4><img src="'+F+'" style="zoom:100%;"><h3 id="ssl-协议握手的-nginx-性能瓶颈" tabindex="-1">SSL 协议握手的 Nginx 性能瓶颈 <a class="header-anchor" href="#ssl-协议握手的-nginx-性能瓶颈" aria-label="Permalink to &quot;SSL 协议握手的 Nginx 性能瓶颈&quot;">​</a></h3><h4 id="tls-通讯过程" tabindex="-1">TLS 通讯过程 <a class="header-anchor" href="#tls-通讯过程" aria-label="Permalink to &quot;TLS 通讯过程&quot;">​</a></h4><img src="'+b+'" style="zoom:100%;"><h4 id="nginx-握手性能" tabindex="-1">Nginx 握手性能 <a class="header-anchor" href="#nginx-握手性能" aria-label="Permalink to &quot;Nginx 握手性能&quot;">​</a></h4><img src="'+x+'" style="zoom:100%;"><h4 id="nginx-数据加密性能" tabindex="-1">Nginx 数据加密性能 <a class="header-anchor" href="#nginx-数据加密性能" aria-label="Permalink to &quot;Nginx 数据加密性能&quot;">​</a></h4><img src="'+v+'" style="zoom:100%;"><h4 id="nginx-综合性能" tabindex="-1">Nginx 综合性能 <a class="header-anchor" href="#nginx-综合性能" aria-label="Permalink to &quot;Nginx 综合性能&quot;">​</a></h4><img src="'+k+`" style="zoom:100%;"><h3 id="免费-ssl-证书实现一个站点" tabindex="-1">免费 SSL 证书实现一个站点 <a class="header-anchor" href="#免费-ssl-证书实现一个站点" aria-label="Permalink to &quot;免费 SSL 证书实现一个站点&quot;">​</a></h3><div class="language-jsx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">jsx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">yum install python2</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">certbot</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">nginx </span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">yum install certbot </span><span style="color:#6A737D;">// 最新</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">yum install python2</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">certbot</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">nginx </span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">yum install certbot </span><span style="color:#6A737D;">// 最新</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">certbot </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">server</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">root</span><span style="color:#F97583;">=/</span><span style="color:#E1E4E8;">etc</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">nginx</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">conf</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">d music.yueluo.club</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">certbot </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">server</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">root</span><span style="color:#D73A49;">=/</span><span style="color:#24292E;">etc</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">nginx</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">conf</span><span style="color:#D73A49;">/</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">d music.yueluo.club</span></span></code></pre></div><h3 id="基于-openresty-实现简单服务" tabindex="-1">基于 OpenResty 实现简单服务 <a class="header-anchor" href="#基于-openresty-实现简单服务" aria-label="Permalink to &quot;基于 OpenResty 实现简单服务&quot;">​</a></h3><h4 id="下载-openresty" tabindex="-1">下载 OpenResty <a class="header-anchor" href="#下载-openresty" aria-label="Permalink to &quot;下载 OpenResty&quot;">​</a></h4><p><a href="https://openresty.org/cn/" target="_blank" rel="noreferrer">https://openresty.org/cn/</a></p><blockquote><p>OpenResty® 是一个基于 <a href="https://openresty.org/cn/nginx.html" target="_blank" rel="noreferrer">Nginx</a> 与 Lua 的高性能 Web 平台，其内部集成了大量精良的 Lua 库、第三方模块以及大多数的依赖项。用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。</p></blockquote><p>下载页面：<a href="https://openresty.org/cn/download.html" target="_blank" rel="noreferrer">https://openresty.org/cn/download.html</a></p><p>通常我们不会下载二进制版本，我们需要下载源码，复制其下载链接</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">wget </span><span style="color:#B392F0;">https</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//openresty.org/download/openresty-1.19.3.2.tar.gz</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">wget </span><span style="color:#6F42C1;">https</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//openresty.org/download/openresty-1.19.3.2.tar.gz</span></span></code></pre></div><h4 id="分析目录结构" tabindex="-1">分析目录结构 <a class="header-anchor" href="#分析目录结构" aria-label="Permalink to &quot;分析目录结构&quot;">​</a></h4><ul><li><p>build 编译生成的目标文件</p></li><li><p>bundle 模块文件，基于 nginx 二次开发</p><ul><li>nginx c 模块</li><li>lua 模块</li></ul></li><li><p>configure</p><ul><li>./configure --help 帮助命令</li></ul></li><li><p>patches</p></li><li><p>util</p></li></ul><h4 id="编译-1" tabindex="-1">编译 <a class="header-anchor" href="#编译-1" aria-label="Permalink to &quot;编译&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">.</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">configure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">make</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">.</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">configure</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">make</span></span></code></pre></div><h4 id="添加-lua-代码" tabindex="-1">添加 lua 代码 <a class="header-anchor" href="#添加-lua-代码" aria-label="Permalink to &quot;添加 lua 代码&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">vim nginx.conf</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">vim nginx.conf</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/lua </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/html;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># http 请求内容生成阶段用 lua 处理</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">content_by_lua</span><span style="color:#E1E4E8;"> &#39;ngx.</span><span style="color:#79B8FF;">say</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;User-Agent: &quot;</span><span style="color:#E1E4E8;">, ngx.</span><span style="color:#B392F0;">req</span><span style="color:#E1E4E8;">.</span><span style="color:#79B8FF;">get_headers</span><span style="color:#E1E4E8;">()[</span><span style="color:#9ECBFF;">&quot;User-Agent&quot;</span><span style="color:#E1E4E8;">])&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">html/music/;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/lua </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/html;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># http 请求内容生成阶段用 lua 处理</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">content_by_lua</span><span style="color:#24292E;"> &#39;ngx.</span><span style="color:#005CC5;">say</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;User-Agent: &quot;</span><span style="color:#24292E;">, ngx.</span><span style="color:#6F42C1;">req</span><span style="color:#24292E;">.</span><span style="color:#005CC5;">get_headers</span><span style="color:#24292E;">()[</span><span style="color:#032F62;">&quot;User-Agent&quot;</span><span style="color:#24292E;">])&#39;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">html/music/;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="运行" tabindex="-1">运行 <a class="header-anchor" href="#运行" aria-label="Permalink to &quot;运行&quot;">​</a></h4><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s reload</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s reload</span></span></code></pre></div><h2 id="二、nginx-架构基础" tabindex="-1">二、Nginx 架构基础 <a class="header-anchor" href="#二、nginx-架构基础" aria-label="Permalink to &quot;二、Nginx 架构基础&quot;">​</a></h2><h3 id="nginx-的请求处理流程" tabindex="-1">Nginx 的请求处理流程 <a class="header-anchor" href="#nginx-的请求处理流程" aria-label="Permalink to &quot;Nginx 的请求处理流程&quot;">​</a></h3><img src="`+f+'" style="zoom:80%;"><h3 id="nginx-的进程结构" tabindex="-1">Nginx 的进程结构 <a class="header-anchor" href="#nginx-的进程结构" aria-label="Permalink to &quot;Nginx 的进程结构&quot;">​</a></h3><ul><li>单进程结构 <ul><li>不适合生产环境，只适合开发，调试</li></ul></li><li>多进程结构</li></ul><p>多进程模型</p><ul><li>nginx 需要保持高可用性和高可靠性，所以不能使用线程，线程之间存在共享空间</li><li>master 进程中通常不会加入第三方模块代码 <ul><li>master 主要是用来做进程管理，处理 worker 进程</li><li>缓存需要被 worker 进程使用，也要被 Cache manager 进程使用</li></ul></li><li>woker 进程为什么很多 <ul><li>nginx 采用事件驱动模型之后，希望每个 worker 进程从头到尾占用一个 CPU，可以更好地使用 CPU 缓存</li></ul></li></ul><img src="'+A+`" style="zoom:100%;"><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">ps </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">ef </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> grep nginx </span><span style="color:#6A737D;">// 查看 nginx 进程</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">ps </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">ef </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> grep nginx </span><span style="color:#6A737D;">// 查看 nginx 进程</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s reload </span><span style="color:#6A737D;">// 重载 nginx 服务，会重新开启新的 worker 子进程和 Cache manager 进程</span></span>
<span class="line"><span style="color:#E1E4E8;">kill </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">SIGHUP</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9170</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// SIGHUP 信号和 reload 作用是一致的</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s reload </span><span style="color:#6A737D;">// 重载 nginx 服务，会重新开启新的 worker 子进程和 Cache manager 进程</span></span>
<span class="line"><span style="color:#24292E;">kill </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">SIGHUP</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9170</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// SIGHUP 信号和 reload 作用是一致的</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">kill </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">SIGTERM</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">9862</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 退出子进程，子进程会通知父进程，父进程会重启一个子进程</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">kill </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">SIGTERM</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">9862</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 退出子进程，子进程会通知父进程，父进程会重启一个子进程</span></span></code></pre></div><h3 id="信号管理-nginx-父进程" tabindex="-1">信号管理 Nginx 父进程 <a class="header-anchor" href="#信号管理-nginx-父进程" aria-label="Permalink to &quot;信号管理 Nginx 父进程&quot;">​</a></h3><p>Master 进程</p><ul><li><p>TERM 立刻停止 Nginx 进程</p></li><li><p>QUIT 优雅的停止 Nginx 进程</p></li><li><p>HUP 重载配置文件</p></li><li><p>USR1 重新打开日志文件，进行日志文件切割</p></li><li><p>以上 4 个命令可以通过命令行向 master 进程发送</p></li><li><p>USR2</p></li><li><p>WINCH</p></li><li><p>以上 2 个命令只能通过 kill linux 命令行向 master 进程发送</p></li></ul><img src="`+D+'" style="zoom:90%;"><blockquote><p>调用 Nginx 命令行发送相应命令本质是也是发送信号指令。</p></blockquote><h3 id="reload-重载配置文件的原理" tabindex="-1">reload 重载配置文件的原理 <a class="header-anchor" href="#reload-重载配置文件的原理" aria-label="Permalink to &quot;reload 重载配置文件的原理&quot;">​</a></h3><img src="'+C+'" style="zoom:90%;"><img src="'+q+'" style="zoom:90%;"><p>老进程由于异常导致无法正常关闭，这时可以配置 worker_shutdonwn_timeout 最长等待时间，master 开启子进程之后会开启定时器，如果定时时间到达之后，老的 workder 进程还没有关闭，会强制关闭。</p><h3 id="热升级的完整流程" tabindex="-1">热升级的完整流程 <a class="header-anchor" href="#热升级的完整流程" aria-label="Permalink to &quot;热升级的完整流程&quot;">​</a></h3><p>替换 Nginx 文件：替换 bundary 文件。</p><img src="'+B+'" style="zoom:90%;"><img src="'+P+`" style="zoom:90%;"><h3 id="优雅地关闭-worker-进程" tabindex="-1">优雅地关闭 worker 进程 <a class="header-anchor" href="#优雅地关闭-worker-进程" aria-label="Permalink to &quot;优雅地关闭 worker 进程&quot;">​</a></h3><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s reload </span><span style="color:#6A737D;">// 优雅关闭</span></span>
<span class="line"><span style="color:#E1E4E8;">nginx </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">s stop </span><span style="color:#6A737D;">// 立即关闭</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s reload </span><span style="color:#6A737D;">// 优雅关闭</span></span>
<span class="line"><span style="color:#24292E;">nginx </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">s stop </span><span style="color:#6A737D;">// 立即关闭</span></span></code></pre></div><p>优雅关闭是对 worker 进程 的 http 请求 而言的。</p><p>当老进程进行 WebSocket 通信时，或者进行 TCP 请求时，nginx 不知道什么时候应该关闭。</p><img src="`+z+'" style="zoom:90%;"><h3 id="网络收发与-nginx-事件间的对应关系" tabindex="-1">网络收发与 Nginx 事件间的对应关系 <a class="header-anchor" href="#网络收发与-nginx-事件间的对应关系" aria-label="Permalink to &quot;网络收发与 Nginx 事件间的对应关系&quot;">​</a></h3><p>Nginx 是一个事件驱动的框架，这里的事件指的是网络事件。</p><h4 id="网络传输" tabindex="-1">网络传输 <a class="header-anchor" href="#网络传输" aria-label="Permalink to &quot;网络传输&quot;">​</a></h4><img src="'+w+'" style="zoom:90%;"><h4 id="tcp-与报文" tabindex="-1">TCP 与报文 <a class="header-anchor" href="#tcp-与报文" aria-label="Permalink to &quot;TCP 与报文&quot;">​</a></h4><img src="'+$+'" style="zoom:90%;"><h4 id="tcp-协议与非阻塞接口" tabindex="-1">TCP 协议与非阻塞接口 <a class="header-anchor" href="#tcp-协议与非阻塞接口" aria-label="Permalink to &quot;TCP 协议与非阻塞接口&quot;">​</a></h4><p>事件收集、分发器，我们会定义每个事件对应的消费者。</p><img src="'+T+'" style="zoom:90%;"><h3 id="nginx-的事件驱动模型" tabindex="-1">Nginx 的事件驱动模型 <a class="header-anchor" href="#nginx-的事件驱动模型" aria-label="Permalink to &quot;Nginx 的事件驱动模型&quot;">​</a></h3><img src="'+j+'" style="zoom:90%;"><h3 id="epoll-的优势及原理" tabindex="-1">epoll 的优势及原理 <a class="header-anchor" href="#epoll-的优势及原理" aria-label="Permalink to &quot;epoll 的优势及原理&quot;">​</a></h3><img src="'+N+'" style="zoom:90%;"><h3 id="nginx-的事件切换" tabindex="-1">Nginx 的事件切换 <a class="header-anchor" href="#nginx-的事件切换" aria-label="Permalink to &quot;Nginx 的事件切换&quot;">​</a></h3><img src="'+S+'" style="zoom:90%;"><h3 id="同步-异步、阻塞与非阻塞" tabindex="-1">同步，异步、阻塞与非阻塞 <a class="header-anchor" href="#同步-异步、阻塞与非阻塞" aria-label="Permalink to &quot;同步，异步、阻塞与非阻塞&quot;">​</a></h3><p>阻塞和非阻塞主要是指操作系统或者底层 C 库提供的方法或者系统调用，调用方法是否会导致进程进程 sleep 状态。</p><h4 id="阻塞调用" tabindex="-1">阻塞调用 <a class="header-anchor" href="#阻塞调用" aria-label="Permalink to &quot;阻塞调用&quot;">​</a></h4><img src="'+H+'" style="zoom:90%;"><h4 id="非阻塞调用" tabindex="-1">非阻塞调用 <a class="header-anchor" href="#非阻塞调用" aria-label="Permalink to &quot;非阻塞调用&quot;">​</a></h4><img src="'+R+'" style="zoom:90%;"><h4 id="非阻塞调用下的同步与异步" tabindex="-1">非阻塞调用下的同步与异步 <a class="header-anchor" href="#非阻塞调用下的同步与异步" aria-label="Permalink to &quot;非阻塞调用下的同步与异步&quot;">​</a></h4><img src="'+I+'" style="zoom:90%;"><h3 id="nginx-的模块" tabindex="-1">Nginx 的模块 <a class="header-anchor" href="#nginx-的模块" aria-label="Permalink to &quot;Nginx 的模块&quot;">​</a></h3><p><a href="https://nginx.org/en/docs" target="_blank" rel="noreferrer">https://nginx.org/en/docs</a> 官方文档。</p><p>我们可以从官方文档或者编译出的 nginx 源码来查看具体使用方式。</p><p>Nginx 模块定义：</p><ul><li>ngx_module_t 是每一个模块都具备的 <ul><li>type 定义模块类型</li></ul></li></ul><img src="'+U+'" style="zoom:90%;"><h3 id="nginx-模块的分类" tabindex="-1">Nginx 模块的分类 <a class="header-anchor" href="#nginx-模块的分类" aria-label="Permalink to &quot;Nginx 模块的分类&quot;">​</a></h3><ul><li><p>ngx_conf_module：解析 Nginx conf 文件</p></li><li><p>核心模块</p><ul><li>http <ul><li>ngx_http_core_module</li><li>请求过滤模块</li><li>响应过滤模块</li></ul></li><li>cvcnts</li><li>strcam</li></ul></li></ul><img src="'+L+`" style="zoom:90%;"><h3 id="nginx-如何通过连接池处理网络请求" tabindex="-1">Nginx 如何通过连接池处理网络请求 <a class="header-anchor" href="#nginx-如何通过连接池处理网络请求" aria-label="Permalink to &quot;Nginx 如何通过连接池处理网络请求&quot;">​</a></h3><p>。。。。</p><h2 id="三、http-模块" tabindex="-1">三、HTTP 模块 <a class="header-anchor" href="#三、http-模块" aria-label="Permalink to &quot;三、HTTP 模块&quot;">​</a></h2><h3 id="冲突的配置指令以谁为准" tabindex="-1">冲突的配置指令以谁为准 <a class="header-anchor" href="#冲突的配置指令以谁为准" aria-label="Permalink to &quot;冲突的配置指令以谁为准&quot;">​</a></h3><h4 id="配置块嵌套" tabindex="-1">配置块嵌套 <a class="header-anchor" href="#配置块嵌套" aria-label="Permalink to &quot;配置块嵌套&quot;">​</a></h4><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">main</span></span>
<span class="line"><span style="color:#F97583;">http</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">upstream</span><span style="color:#E1E4E8;"> {...}</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> split_clients </span><span style="color:#E1E4E8;">{...}</span></span>
<span class="line"><span style="color:#E1E4E8;">  map {}</span></span>
<span class="line"><span style="color:#E1E4E8;">  geo {}</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  server {</span></span>
<span class="line"><span style="color:#E1E4E8;">    if () {}</span></span>
<span class="line"><span style="color:#E1E4E8;">    location {</span></span>
<span class="line"><span style="color:#E1E4E8;">      limit_except {...}</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    location {</span></span>
<span class="line"><span style="color:#E1E4E8;">      location {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span></span>
<span class="line"><span style="color:#E1E4E8;">      }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  server {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">main</span></span>
<span class="line"><span style="color:#D73A49;">http</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> {...}</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> split_clients </span><span style="color:#24292E;">{...}</span></span>
<span class="line"><span style="color:#24292E;">  map {}</span></span>
<span class="line"><span style="color:#24292E;">  geo {}</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  server {</span></span>
<span class="line"><span style="color:#24292E;">    if () {}</span></span>
<span class="line"><span style="color:#24292E;">    location {</span></span>
<span class="line"><span style="color:#24292E;">      limit_except {...}</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    location {</span></span>
<span class="line"><span style="color:#24292E;">      location {</span></span>
<span class="line"><span style="color:#24292E;">        </span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  server {</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="指令的-context" tabindex="-1">指令的 Context <a class="header-anchor" href="#指令的-context" aria-label="Permalink to &quot;指令的 Context&quot;">​</a></h4><img src="`+O+'" style="zoom:90%;"><h4 id="指令的合并" tabindex="-1">指令的合并 <a class="header-anchor" href="#指令的合并" aria-label="Permalink to &quot;指令的合并&quot;">​</a></h4><img src="'+X+'" style="zoom:90%;"><h4 id="存储值的指令继承规则-向上覆盖" tabindex="-1">存储值的指令继承规则：向上覆盖 <a class="header-anchor" href="#存储值的指令继承规则-向上覆盖" aria-label="Permalink to &quot;存储值的指令继承规则：向上覆盖&quot;">​</a></h4><img src="'+G+'" style="zoom:90%;"><h4 id="http-模块合并配置的实现" tabindex="-1">HTTP 模块合并配置的实现 <a class="header-anchor" href="#http-模块合并配置的实现" aria-label="Permalink to &quot;HTTP 模块合并配置的实现&quot;">​</a></h4><p>并不是所有的指令合并都遵循向上覆盖的原则，我们还需要注意以下几点。</p><img src="'+M+'" style="zoom:90%;"><h3 id="listen-指令的用法" tabindex="-1">Listen 指令的用法 <a class="header-anchor" href="#listen-指令的用法" aria-label="Permalink to &quot;Listen 指令的用法&quot;">​</a></h3><img src="'+W+'" style="zoom:90%;"><h3 id="处理-http-请求头部的流程" tabindex="-1">处理 HTTP 请求头部的流程 <a class="header-anchor" href="#处理-http-请求头部的流程" aria-label="Permalink to &quot;处理 HTTP 请求头部的流程&quot;">​</a></h3><h4 id="接收请求事件模块" tabindex="-1">接收请求事件模块 <a class="header-anchor" href="#接收请求事件模块" aria-label="Permalink to &quot;接收请求事件模块&quot;">​</a></h4><img src="'+K+'" style="zoom:90%;"><h4 id="接收请求-http-模块" tabindex="-1">接收请求 HTTP 模块 <a class="header-anchor" href="#接收请求-http-模块" aria-label="Permalink to &quot;接收请求 HTTP 模块&quot;">​</a></h4><img src="'+V+'" style="zoom:90%;"><h3 id="nginx-中的正则表达式" tabindex="-1">Nginx 中的正则表达式 <a class="header-anchor" href="#nginx-中的正则表达式" aria-label="Permalink to &quot;Nginx 中的正则表达式&quot;">​</a></h3><p>可以使用 pcre test 测试正则表达式。</p><img src="'+Z+'" style="zoom:90%;"><img src="'+Q+`" style="zoom:90%;"><h3 id="如何找到处理请求的-server-指令" tabindex="-1">如何找到处理请求的 server 指令 <a class="header-anchor" href="#如何找到处理请求的-server-指令" aria-label="Permalink to &quot;如何找到处理请求的 server 指令&quot;">​</a></h3><h4 id="server-name-指令" tabindex="-1">server_name 指令 <a class="header-anchor" href="#server-name-指令" aria-label="Permalink to &quot;server_name 指令&quot;">​</a></h4><p>指令后可以跟多个域名，第 1 个是主域名。</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: server_name_in_direct on </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> off;</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: server_name_in_redirect off;</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http,server,location</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: server_name_in_direct on </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> off;</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: server_name_in_redirect off;</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http,server,location</span></span></code></pre></div><p>*泛域名：仅支持在最前或者最后</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">例如：server_name </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">.yueluo.club</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">例如：server_name </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">.yueluo.club</span></span></code></pre></div><p>正则表达式：加 ~ 前缀</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">server_name www.yueluo.club </span><span style="color:#F97583;">~^</span><span style="color:#E1E4E8;">www\\d</span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;">\\.yueluo\\.club$;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">server_name www.yueluo.club </span><span style="color:#D73A49;">~^</span><span style="color:#24292E;">www\\d</span><span style="color:#D73A49;">+</span><span style="color:#24292E;">\\.yueluo\\.club$;</span></span></code></pre></div><p>用正则表达式创建变量：用小括号</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> server_name ~</span><span style="color:#E1E4E8;">^(www\\.)?(.+)S;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">/sites/$2; }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> server_name ~</span><span style="color:#E1E4E8;">^(www\\.)?(?&lt;domain&gt;.+)S;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">/sites/$domain; }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> server_name ~</span><span style="color:#24292E;">^(www\\.)?(.+)S;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">/sites/$2; }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> server_name ~</span><span style="color:#24292E;">^(www\\.)?(?&lt;domain&gt;.+)S;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">/sites/$domain; }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>其他</p><ul><li>.yueluo.club 可以匹配 yueluo.club *.yueluo.club</li><li>_匹配所有 <ul><li>yueluo.club_</li></ul></li><li>“” 匹配没有传递 Host 头部</li></ul><h4 id="server-匹配顺序" tabindex="-1">Server 匹配顺序 <a class="header-anchor" href="#server-匹配顺序" aria-label="Permalink to &quot;Server 匹配顺序&quot;">​</a></h4><ul><li><p>精确匹配</p></li><li><p><code>*</code> 在前的泛域名</p></li><li><p><code>*</code> 在后的泛域名</p></li><li><p>按文件中的顺序匹配正则表达式域名</p></li><li><p>default server</p><ul><li>第 1 个</li><li>listen 指定 default</li></ul></li></ul><h3 id="http-请求的-11-个阶段" tabindex="-1">HTTP 请求的 11 个阶段 <a class="header-anchor" href="#http-请求的-11-个阶段" aria-label="Permalink to &quot;HTTP 请求的 11 个阶段&quot;">​</a></h3><img src="`+Y+'" style="zoom:100%;"><img src="'+J+'" style="zoom:100%;"><h3 id="postread-阶段" tabindex="-1">postread 阶段 <a class="header-anchor" href="#postread-阶段" aria-label="Permalink to &quot;postread 阶段&quot;">​</a></h3><h4 id="获取真实客户端地址的-realip-模块" tabindex="-1">获取真实客户端地址的 realip 模块 <a class="header-anchor" href="#获取真实客户端地址的-realip-模块" aria-label="Permalink to &quot;获取真实客户端地址的 realip 模块&quot;">​</a></h4><ul><li>TCP 连接四元组（src ip，src port，dst ip，dst port）</li><li>HTTP 头部 X-Forwarded-For 用于传递 IP</li><li>HTTP 头部 X-Real-IP 用户传递用户 IP</li><li>网络中存在许多反向代理</li></ul><img src="'+ss+'" style="zoom:60%;"><p>我们可以根据 X-Forwarded-For 获取到真实 IP，获取到真实 IP 之后如何使用？</p><p>答案是基于变量。像 binary_remote_addr、remote_addr 这样的变量，其值就是真实的 IP，这样做连接限制（limit_conn 模块）才有意义。</p><h4 id="realip-模块" tabindex="-1">realip 模块 <a class="header-anchor" href="#realip-模块" aria-label="Permalink to &quot;realip 模块&quot;">​</a></h4><p>realip 模块默认不会编译进 Nginx</p><ul><li>通过 --with-http_realip_module 启用功能</li></ul><p>功能</p><ul><li>修改客户端地址</li></ul><p>变量</p><ul><li>realip_remote_addr</li><li>realip_remote_port</li></ul><p>指令</p><ul><li>set_real_ip_from</li><li>real_ip_header</li><li>real_ip_Rrcursive</li></ul><img src="'+as+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">realip.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">data/logs/realip/error.log dubug;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> set_real_ip_from </span><span style="color:#E1E4E8;">xxx.xx.xxx.xxx;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># real_ip_header X-Real_IP;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> real_ip_recursive </span><span style="color:#E1E4E8;">off; </span><span style="color:#6A737D;"># 环回地址</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># real_ip_reucrsize on;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> real_ip_header </span><span style="color:#E1E4E8;">X-Forwared-For;</span></span>
<span class="line"><span style="color:#E1E4E8;">    	</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;Client real ip: $</span><span style="color:#E1E4E8;">remote_addr</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">realip.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">data/logs/realip/error.log dubug;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> set_real_ip_from </span><span style="color:#24292E;">xxx.xx.xxx.xxx;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># real_ip_header X-Real_IP;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> real_ip_recursive </span><span style="color:#24292E;">off; </span><span style="color:#6A737D;"># 环回地址</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># real_ip_reucrsize on;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> real_ip_header </span><span style="color:#24292E;">X-Forwared-For;</span></span>
<span class="line"><span style="color:#24292E;">    	</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;Client real ip: $</span><span style="color:#24292E;">remote_addr</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="rewrite-阶段" tabindex="-1">rewrite 阶段 <a class="header-anchor" href="#rewrite-阶段" aria-label="Permalink to &quot;rewrite 阶段&quot;">​</a></h3><h4 id="return-指令" tabindex="-1">return 指令 <a class="header-anchor" href="#return-指令" aria-label="Permalink to &quot;return 指令&quot;">​</a></h4><img src="`+ns+'" style="zoom:80%;"><img src="'+ls+`" style="zoom:80%;"><p>server 与 location 块下的 return 指令关系？</p><p>return 与 error_page 指令的关系？</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">return.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8080;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html/;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_page </span><span style="color:#E1E4E8;">404 /403.html;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">403</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">404</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;find nothing!&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">return.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8080;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html/;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_page </span><span style="color:#24292E;">404 /403.html;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">403</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">404</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;find nothing!&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>return 是 rewrite 提供的指令。</p><h4 id="rewrite-指令" tabindex="-1">rewrite 指令 <a class="header-anchor" href="#rewrite-指令" aria-label="Permalink to &quot;rewrite 指令&quot;">​</a></h4><img src="`+ps+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html/;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/first </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> /first(.*)/second$1</span><span style="color:#79B8FF;"> last</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;first!&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/second </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> /second(.*)/third$1 </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;second!&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/thrid </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;third!&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html/;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/first </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> /first(.*)/second$1</span><span style="color:#005CC5;"> last</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;first!&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/second </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> /second(.*)/third$1 </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;second!&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/thrid </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;third!&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/redirect1 </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> /redirect(.*)$1 </span><span style="color:#F97583;">permanent</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/redirect2 </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> /redirect2(.*)$1 </span><span style="color:#F97583;">redirect</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/redirect3 </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> /redirect3(.*) http://rewrite.yueluo.club$1;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/redirect4 </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> /redirect4(.*) http://rewrite.yueluo.club$1 </span><span style="color:#F97583;">permanent</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/redirect1 </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> /redirect(.*)$1 </span><span style="color:#D73A49;">permanent</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/redirect2 </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> /redirect2(.*)$1 </span><span style="color:#D73A49;">redirect</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/redirect3 </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> /redirect3(.*) http://rewrite.yueluo.club$1;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/redirect4 </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> /redirect4(.*) http://rewrite.yueluo.club$1 </span><span style="color:#D73A49;">permanent</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><img src="`+os+'" style="zoom:80%;"><blockquote><p>rewrite_on 指令默认是不打开的，如果打开会记录到 error.log 日志中。</p></blockquote><h4 id="条件判断-if" tabindex="-1">条件判断 if <a class="header-anchor" href="#条件判断-if" aria-label="Permalink to &quot;条件判断 if&quot;">​</a></h4><img src="'+es+`" style="zoom:80%;"><p>if 指令的条件表达式</p><ul><li>检查变量为空或者值是否为 0，直接使用</li><li>将变量与字符串做匹配，使用 = 或者 !=</li><li>将变量与正则表达式做匹配 <ul><li>大小写敏感，~ 或者 !~</li><li>大小写不敏感，~* 或者 !~*，忽略大小写</li></ul></li><li>检查文件是否存在，使用 -f 或者 !-f</li><li>检查目录是否存在，使用 -d 或者 !-d</li><li>检查文件、目录、软链接是否存在，使用 -e 或者 !-e</li><li>检查是否为可执行文件，使用 -x 或者 !-x</li></ul><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($http_user_agent </span><span style="color:#F97583;">~ </span><span style="color:#E1E4E8;">MSIE) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> </span><span style="color:#DBEDFF;">^(.*)$</span><span style="color:#E1E4E8;"> /mise/$1 </span><span style="color:#F97583;">break</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($http_cookie </span><span style="color:#F97583;">~* </span><span style="color:#9ECBFF;">&quot;id=([^;]+)()?:;|$) {</span></span>
<span class="line"><span style="color:#9ECBFF;">	set $</span><span style="color:#E1E4E8;">id</span><span style="color:#9ECBFF;"> $</span><span style="color:#E1E4E8;">1</span><span style="color:#9ECBFF;">;</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">if ($</span><span style="color:#E1E4E8;">request_method</span><span style="color:#9ECBFF;"> = POST) {</span></span>
<span class="line"><span style="color:#9ECBFF;">  return 405;</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">if ($</span><span style="color:#E1E4E8;">slow</span><span style="color:#9ECBFF;">) {</span></span>
<span class="line"><span style="color:#9ECBFF;">  limit_rate 10k;</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF;">if ($</span><span style="color:#E1E4E8;">invalid_referer</span><span style="color:#9ECBFF;">) {</span></span>
<span class="line"><span style="color:#9ECBFF;">  return 403;</span></span>
<span class="line"><span style="color:#9ECBFF;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($http_user_agent </span><span style="color:#D73A49;">~ </span><span style="color:#24292E;">MSIE) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> </span><span style="color:#032F62;">^(.*)$</span><span style="color:#24292E;"> /mise/$1 </span><span style="color:#D73A49;">break</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($http_cookie </span><span style="color:#D73A49;">~* </span><span style="color:#032F62;">&quot;id=([^;]+)()?:;|$) {</span></span>
<span class="line"><span style="color:#032F62;">	set $</span><span style="color:#24292E;">id</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">1</span><span style="color:#032F62;">;</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">if ($</span><span style="color:#24292E;">request_method</span><span style="color:#032F62;"> = POST) {</span></span>
<span class="line"><span style="color:#032F62;">  return 405;</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">if ($</span><span style="color:#24292E;">slow</span><span style="color:#032F62;">) {</span></span>
<span class="line"><span style="color:#032F62;">  limit_rate 10k;</span></span>
<span class="line"><span style="color:#032F62;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#032F62;">if ($</span><span style="color:#24292E;">invalid_referer</span><span style="color:#032F62;">) {</span></span>
<span class="line"><span style="color:#032F62;">  return 403;</span></span>
<span class="line"><span style="color:#032F62;">}</span></span></code></pre></div><h3 id="find-config-阶段" tabindex="-1">find_config 阶段 <a class="header-anchor" href="#find-config-阶段" aria-label="Permalink to &quot;find_config 阶段&quot;">​</a></h3><h4 id="location-指令" tabindex="-1">location 指令 <a class="header-anchor" href="#location-指令" aria-label="Permalink to &quot;location 指令&quot;">​</a></h4><img src="`+ts+'" style="zoom:80%;"><p>location 匹配规则：仅匹配 URI，忽略参数</p><ul><li>合并连续的 / 符号 <ul><li>merge_slashes on</li></ul></li><li>前缀字符串 <ul><li>常规</li><li>=: 精确匹配</li><li>^~：匹配上后则不再进行正则表达式匹配</li></ul></li><li>用于内部跳转的命名 location <ul><li>@</li></ul></li><li>正则表达式 <ul><li>~：大小写敏感的正则匹配</li><li>~*：忽略大小写的正则匹配</li></ul></li></ul><p>location 匹配顺序</p><img src="'+rs+'" style="zoom:80%;"><h3 id="preaccess-阶段" tabindex="-1">preaccess 阶段 <a class="header-anchor" href="#preaccess-阶段" aria-label="Permalink to &quot;preaccess 阶段&quot;">​</a></h3><h4 id="limit-conn" tabindex="-1">limit_conn <a class="header-anchor" href="#limit-conn" aria-label="Permalink to &quot;limit_conn&quot;">​</a></h4><p>限制每个客户端的并发连接数</p><img src="'+cs+`" style="zoom:80%;"><p>步骤：</p><ul><li>定义共享内存（包括大小），以及 key 关键字</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_conn_zone key zone</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">:size; </span><span style="color:#6A737D;">// 共享内存大小</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">-</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_conn_zone key zone</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">:size; </span><span style="color:#6A737D;">// 共享内存大小</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">-</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http</span></span></code></pre></div><ul><li>限制并发连接数</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_conn zone number;</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: </span><span style="color:#F97583;">-</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http, server, location</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_conn zone number;</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: </span><span style="color:#D73A49;">-</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http, server, location</span></span></code></pre></div><ul><li>限制发生时的日志级别</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_conn_log_level info </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> notice </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> warn </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: limit_conn_log_level error;</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http, server, location</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_conn_log_level info </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> notice </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> warn </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> error;</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: limit_conn_log_level error;</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http, server, location</span></span></code></pre></div><ul><li>限制发生时向客户端返回的错误码</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_conn_status code;</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: limit_conn_status </span><span style="color:#79B8FF;">503</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http, server, location</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_conn_status code;</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: limit_conn_status </span><span style="color:#005CC5;">503</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http, server, location</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">limit_conn_zone </span><span style="color:#E1E4E8;">$binary_remote_addr zone=addr:10m;</span></span>
<span class="line"><span style="color:#6A737D;"># limit_conn_zone $binary_remote_addr zone=one: 10m rate=3r/s;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">limit.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html/;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/myerror.log info;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_conn_status </span><span style="color:#E1E4E8;">500;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_conn_log_level </span><span style="color:#E1E4E8;">warn;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_rate </span><span style="color:#E1E4E8;">50;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_conn </span><span style="color:#E1E4E8;">addr </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># limit_req zone=one brust=1 nodelay;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># limit_req zone=one;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">limit_conn_zone </span><span style="color:#24292E;">$binary_remote_addr zone=addr:10m;</span></span>
<span class="line"><span style="color:#6A737D;"># limit_conn_zone $binary_remote_addr zone=one: 10m rate=3r/s;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">limit.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html/;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/myerror.log info;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_conn_status </span><span style="color:#24292E;">500;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_conn_log_level </span><span style="color:#24292E;">warn;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_rate </span><span style="color:#24292E;">50;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_conn </span><span style="color:#24292E;">addr </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># limit_req zone=one brust=1 nodelay;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># limit_req zone=one;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="limit-req" tabindex="-1">limit_req <a class="header-anchor" href="#limit-req" aria-label="Permalink to &quot;limit_req&quot;">​</a></h4><p>限制每个客户端的每秒处理请求数</p><img src="`+is+`" style="zoom:80%;"><p>步骤：</p><ul><li>定义共享内存（包括大小），以及 key 关键字和限制速率</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_req_zone key zone</span><span style="color:#F97583;">=</span><span style="color:#B392F0;">name</span><span style="color:#E1E4E8;">:size rate</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">rate;</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: _;</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// rate 单位为 r/s 或者 r/m</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_req_zone key zone</span><span style="color:#D73A49;">=</span><span style="color:#6F42C1;">name</span><span style="color:#24292E;">:size rate</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">rate;</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: _;</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// rate 单位为 r/s 或者 r/m</span></span></code></pre></div><ul><li>限制并发连接数</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_req zone</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">name [brust</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">number][nodelay];</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: _</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http,server,location</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// brust 默认为 0</span></span>
<span class="line"><span style="color:#6A737D;">// nodelay，对 burst 中的请求不再采用延时处理的做法，而是立即处理</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_req zone</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">name [brust</span><span style="color:#D73A49;">=</span><span style="color:#24292E;">number][nodelay];</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: _</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http,server,location</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// brust 默认为 0</span></span>
<span class="line"><span style="color:#6A737D;">// nodelay，对 burst 中的请求不再采用延时处理的做法，而是立即处理</span></span></code></pre></div><ul><li>限制发生时的日志级别</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_req_log_level info </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> notice </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> warn </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> error;</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: limit_req_log_level error;</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http, server, location</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_req_log_level info </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> notice </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> warn </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> error;</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: limit_req_log_level error;</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http, server, location</span></span></code></pre></div><ul><li>限制发生时向客户端返回的错误码</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Syntax</span><span style="color:#E1E4E8;">: limit_red_status code;</span></span>
<span class="line"><span style="color:#B392F0;">Default</span><span style="color:#E1E4E8;">: limit_red_status </span><span style="color:#79B8FF;">503</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#B392F0;">Context</span><span style="color:#E1E4E8;">: http, server, location</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Syntax</span><span style="color:#24292E;">: limit_red_status code;</span></span>
<span class="line"><span style="color:#6F42C1;">Default</span><span style="color:#24292E;">: limit_red_status </span><span style="color:#005CC5;">503</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#6F42C1;">Context</span><span style="color:#24292E;">: http, server, location</span></span></code></pre></div><p>limit_req 与 limit_conn 配置同时生效时，那个有效？</p><p>nodelay 添加与否，有什么不同？</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">limit_conn_zone </span><span style="color:#E1E4E8;">$binary_remote_addr zone=addr:10m;</span></span>
<span class="line"><span style="color:#F97583;">limit_conn_zone </span><span style="color:#E1E4E8;">$binary_remote_addr zone=one: </span><span style="color:#79B8FF;">10m</span><span style="color:#E1E4E8;"> rate=2r/m;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">limit.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html/;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/myerror.log info;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_conn_status </span><span style="color:#E1E4E8;">500;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_conn_log_level </span><span style="color:#E1E4E8;">warn;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># limit_rate 50;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># limit_conn addr 1;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_req </span><span style="color:#E1E4E8;">zone=one brust=1 nodelay;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> limit_req </span><span style="color:#E1E4E8;">zone=one;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">limit_conn_zone </span><span style="color:#24292E;">$binary_remote_addr zone=addr:10m;</span></span>
<span class="line"><span style="color:#D73A49;">limit_conn_zone </span><span style="color:#24292E;">$binary_remote_addr zone=one: </span><span style="color:#005CC5;">10m</span><span style="color:#24292E;"> rate=2r/m;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">limit.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html/;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/myerror.log info;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_conn_status </span><span style="color:#24292E;">500;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_conn_log_level </span><span style="color:#24292E;">warn;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># limit_rate 50;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># limit_conn addr 1;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_req </span><span style="color:#24292E;">zone=one brust=1 nodelay;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> limit_req </span><span style="color:#24292E;">zone=one;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="access-阶段" tabindex="-1">access 阶段 <a class="header-anchor" href="#access-阶段" aria-label="Permalink to &quot;access 阶段&quot;">​</a></h3><p>nginx_http_access_module 模块</p><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">生效阶段：</span><span style="color:#79B8FF;">NGX_HTPP_ACCESS_PHASE</span></span>
<span class="line"><span style="color:#E1E4E8;">模块：http_access_module</span></span>
<span class="line"><span style="color:#E1E4E8;">默认编译进 nginx，通过 </span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;">without</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">http_access_module 禁用功能</span></span>
<span class="line"><span style="color:#E1E4E8;">生效范围：进入 access 阶段前不生效</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">生效阶段：</span><span style="color:#005CC5;">NGX_HTPP_ACCESS_PHASE</span></span>
<span class="line"><span style="color:#24292E;">模块：http_access_module</span></span>
<span class="line"><span style="color:#24292E;">默认编译进 nginx，通过 </span><span style="color:#D73A49;">--</span><span style="color:#24292E;">without</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">http_access_module 禁用功能</span></span>
<span class="line"><span style="color:#24292E;">生效范围：进入 access 阶段前不生效</span></span></code></pre></div><h4 id="deny-allow-限制-ip" tabindex="-1">deny/allow：限制 IP <a class="header-anchor" href="#deny-allow-限制-ip" aria-label="Permalink to &quot;deny/allow：限制 IP&quot;">​</a></h4><img src="`+Es+'" style="zoom:80%;"><h4 id="auth-basic-用户名密码限制" tabindex="-1">auth_basic：用户名密码限制 <a class="header-anchor" href="#auth-basic-用户名密码限制" aria-label="Permalink to &quot;auth_basic：用户名密码限制&quot;">​</a></h4><img src="'+ys+'" style="zoom:80%;"><img src="'+ds+`" style="zoom:80%;"><p>如何生成密码文件</p><ul><li>文件格式</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;"># comment</span></span>
<span class="line"><span style="color:#B392F0;">name1</span><span style="color:#E1E4E8;">:password1</span></span>
<span class="line"><span style="color:#B392F0;">name2</span><span style="color:#E1E4E8;">:</span><span style="color:#B392F0;">password2</span><span style="color:#E1E4E8;">:comment</span></span>
<span class="line"><span style="color:#B392F0;">name3</span><span style="color:#E1E4E8;">:password3</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;"># comment</span></span>
<span class="line"><span style="color:#6F42C1;">name1</span><span style="color:#24292E;">:password1</span></span>
<span class="line"><span style="color:#6F42C1;">name2</span><span style="color:#24292E;">:</span><span style="color:#6F42C1;">password2</span><span style="color:#24292E;">:comment</span></span>
<span class="line"><span style="color:#6F42C1;">name3</span><span style="color:#24292E;">:password3</span></span></code></pre></div><ul><li>生成工具 htpasswd</li></ul><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">依赖安装包：httpd</span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">tools</span></span>
<span class="line"><span style="color:#E1E4E8;">htpasswd </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">c file </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">b user pass</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">依赖安装包：httpd</span><span style="color:#D73A49;">-</span><span style="color:#24292E;">tools</span></span>
<span class="line"><span style="color:#24292E;">htpasswd </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">c file </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">b user pass</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> satisfy </span><span style="color:#E1E4E8;">any;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> auth_basic </span><span style="color:#9ECBFF;">&quot;test auth_basic&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> auth_basic_user_file </span><span style="color:#E1E4E8;">examples/auth.pass;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> deny </span><span style="color:#E1E4E8;">all;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/auth_request </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> auth_request </span><span style="color:#E1E4E8;">/test_auth;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#DBEDFF;">/test_auth </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://127.0.0.1:8090/auth_upstream;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass_request_body </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">Content-Length </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">X-Original-URI $request_uri;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> satisfy </span><span style="color:#24292E;">any;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> auth_basic </span><span style="color:#032F62;">&quot;test auth_basic&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> auth_basic_user_file </span><span style="color:#24292E;">examples/auth.pass;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> deny </span><span style="color:#24292E;">all;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/auth_request </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> auth_request </span><span style="color:#24292E;">/test_auth;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/test_auth </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://127.0.0.1:8090/auth_upstream;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass_request_body </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Content-Length </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Original-URI $request_uri;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="auth-request-第三方权限控制" tabindex="-1">auth_request：第三方权限控制 <a class="header-anchor" href="#auth-request-第三方权限控制" aria-label="Permalink to &quot;auth_request：第三方权限控制&quot;">​</a></h4><p>统一的用户权限验证系统</p><img src="`+hs+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> auth_request </span><span style="color:#E1E4E8;">/test_auth;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#DBEDFF;">/test_auth </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://127.0.0.1:8090/auth_upstream;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass_request_body </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">Content-Length </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">X-Original-URI $request_uri;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> auth_request </span><span style="color:#24292E;">/test_auth;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/test_auth </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://127.0.0.1:8090/auth_upstream;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass_request_body </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Content-Length </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Original-URI $request_uri;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="satisfy-指令" tabindex="-1">satisfy 指令 <a class="header-anchor" href="#satisfy-指令" aria-label="Permalink to &quot;satisfy 指令&quot;">​</a></h4><p>satisfy 模块允许改变模块执行顺序。</p><img src="`+us+`" style="zoom:80%;"><p>如果有 return 指令，access 阶段会生效吗？</p><blockquote><p>不会生效，return 指令生效阶段在 rewrite 阶段，领先于 access。</p></blockquote><p>多个 access 模块的顺序有影响吗？</p><ul><li>查看 ngx_modules.c <ul><li>&amp;ngx_http_auth_request_module</li><li>&amp;ngx_http_auth_basic_module</li><li>&amp;ngx_http_access_module</li></ul></li></ul><blockquote><p>会。</p></blockquote><p>输对密码，下面可以访问到文件吗？</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> satisfy </span><span style="color:#E1E4E8;">any;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> auth_basic </span><span style="color:#9ECBFF;">&quot;test auth_basic&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> auth_basic_user_file </span><span style="color:#E1E4E8;">examples/auth.pass;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> deny </span><span style="color:#E1E4E8;">all;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> satisfy </span><span style="color:#24292E;">any;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> auth_basic </span><span style="color:#032F62;">&quot;test auth_basic&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> auth_basic_user_file </span><span style="color:#24292E;">examples/auth.pass;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> deny </span><span style="color:#24292E;">all;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><blockquote><p>可以。</p></blockquote><p>如果把 deny all 提到 auth_basic 之前呢？</p><blockquote><p>可以。</p></blockquote><p>如果改为 allow all，有机会输入密码吗？</p><blockquote><p>没有机会。</p></blockquote><h3 id="precontent-阶段" tabindex="-1">precontent 阶段 <a class="header-anchor" href="#precontent-阶段" aria-label="Permalink to &quot;precontent 阶段&quot;">​</a></h3><h4 id="try-files-指令" tabindex="-1">try_files 指令 <a class="header-anchor" href="#try-files-指令" aria-label="Permalink to &quot;try_files 指令&quot;">​</a></h4><p>默认编译进 nginx 中。</p><img src="`+gs+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/first </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> try_files </span><span style="color:#E1E4E8;">/system/index.html $uri $uri/index.html $uri @lasturl;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">@lasturl </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;lasturl!</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/second </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> try_files </span><span style="color:#E1E4E8;">$uri $uri/index.html $uri.html = </span><span style="color:#79B8FF;">404</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/first </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> try_files </span><span style="color:#24292E;">/system/index.html $uri $uri/index.html $uri @lasturl;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">@lasturl </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;lasturl!</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/second </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> try_files </span><span style="color:#24292E;">$uri $uri/index.html $uri.html = </span><span style="color:#005CC5;">404</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="mirror-模块-实时拷贝流量" tabindex="-1">mirror 模块：实时拷贝流量 <a class="header-anchor" href="#mirror-模块-实时拷贝流量" aria-label="Permalink to &quot;mirror 模块：实时拷贝流量&quot;">​</a></h4><img src="`+_s+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">10020;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;mirror response!&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8081;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">data/error.log</span><span style="color:#79B8FF;"> debug</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> mirror </span><span style="color:#E1E4E8;">/mirror;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> mirror_request_body </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#DBEDFF;">/mirror </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">internal</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># 内部请求</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://127.0.0.1:10020$request_uri;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass_request_body </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">Content-Length </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">X-Original-URI $request_uri;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">10020;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;mirror response!&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8081;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">data/error.log</span><span style="color:#005CC5;"> debug</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> mirror </span><span style="color:#24292E;">/mirror;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> mirror_request_body </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/mirror </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">internal</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># 内部请求</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://127.0.0.1:10020$request_uri;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass_request_body </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Content-Length </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">X-Original-URI $request_uri;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="content-阶段" tabindex="-1">content 阶段 <a class="header-anchor" href="#content-阶段" aria-label="Permalink to &quot;content 阶段&quot;">​</a></h3><h4 id="static-模块" tabindex="-1">static 模块 <a class="header-anchor" href="#static-模块" aria-label="Permalink to &quot;static 模块&quot;">​</a></h4><h5 id="root-和-alias-指令" tabindex="-1">root 和 alias 指令 <a class="header-anchor" href="#root-和-alias-指令" aria-label="Permalink to &quot;root 和 alias 指令&quot;">​</a></h5><p>都会用于把 URL 映射为文件，返回静态资源。</p><p>不过 root 会将完整 URL 映射进文件路径中，alias 只会将 location 后的 URL 路径映射到文件路径中。</p><img src="`+ms+`" style="zoom:80%;"><p>root 使用范围更广，且具有默认值。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/root </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/alias </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">html;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">~/root/(\\w+\\.txt) </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html/first/$1;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;"> </span><span style="color:#DBEDFF;">/alias/(\\w+\\.txt) </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">html/first/$1;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/root </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/alias </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">html;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">~/root/(\\w+\\.txt) </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html/first/$1;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">~</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/alias/(\\w+\\.txt) </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">html/first/$1;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h5 id="三个-nginx-变量" tabindex="-1">三个 nginx 变量 <a class="header-anchor" href="#三个-nginx-变量" aria-label="Permalink to &quot;三个 nginx 变量&quot;">​</a></h5><p>当我们访问一个 URI 文件时，会生成三个相关变量。</p><ul><li>request_filename：待访问文件的完整路径</li><li>document_root：由 URI 和 root/alias 规则生成的文件夹路径</li><li>realpath_root：将 document_root 中的软链接等换成真实路径</li></ul><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/RealPath/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">html/realpath/;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;$</span><span style="color:#E1E4E8;">request_filename</span><span style="color:#9ECBFF;">:$</span><span style="color:#E1E4E8;">document_root</span><span style="color:#9ECBFF;">:$</span><span style="color:#E1E4E8;">document_root</span><span style="color:#9ECBFF;">:$</span><span style="color:#E1E4E8;">realpath_root</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/RealPath/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">html/realpath/;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">request_filename</span><span style="color:#032F62;">:$</span><span style="color:#24292E;">document_root</span><span style="color:#032F62;">:$</span><span style="color:#24292E;">document_root</span><span style="color:#032F62;">:$</span><span style="color:#24292E;">realpath_root</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h5 id="静态文件返回的-content-type" tabindex="-1">静态文件返回的 content-type <a class="header-anchor" href="#静态文件返回的-content-type" aria-label="Permalink to &quot;静态文件返回的 content-type&quot;">​</a></h5><img src="`+Fs+'" style="zoom:80%;"><h5 id="未找到文件的错误日志" tabindex="-1">未找到文件的错误日志 <a class="header-anchor" href="#未找到文件的错误日志" aria-label="Permalink to &quot;未找到文件的错误日志&quot;">​</a></h5><img src="'+bs+'" style="zoom:80%;"><p>可以关闭文件获取不到的错误日志。</p><h5 id="url-不以斜杠结尾访问目录" tabindex="-1">url 不以斜杠结尾访问目录 <a class="header-anchor" href="#url-不以斜杠结尾访问目录" aria-label="Permalink to &quot;url 不以斜杠结尾访问目录&quot;">​</a></h5><p>访问目录时 URL 最后没有带 / ?</p><blockquote><p>static 模块实现了 root/alias 功能，发现访问目标时目录，但 URL 末尾加 / 时，会返回 301 重定向</p></blockquote><img src="'+xs+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">return.yueluo.club dir.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name_in_redirect </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8088;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> port_in_redirect </span><span style="color:#E1E4E8;">on;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> absolute_redirect </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html/;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">return.yueluo.club dir.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name_in_redirect </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8088;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> port_in_redirect </span><span style="color:#24292E;">on;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> absolute_redirect </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html/;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="index、autoindex-模块" tabindex="-1">index、autoindex 模块 <a class="header-anchor" href="#index、autoindex-模块" aria-label="Permalink to &quot;index、autoindex 模块&quot;">​</a></h4><p>访问 / 时的处理</p><img src="`+vs+'" style="zoom:80%;"><p>显示目录内容：content 阶段的 autoindex 模块</p><img src="'+ks+'" style="zoom:80%;"><p>autoindex 模块的指令</p><img src="'+fs+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">autoindex.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8080;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">html/;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> autoindex </span><span style="color:#E1E4E8;">on;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># index a.html</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> autoindex_exact_size </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> autoindex_format </span><span style="color:#E1E4E8;">json;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> autoindex_localtime </span><span style="color:#E1E4E8;">on;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">autoindex.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8080;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">html/;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> autoindex </span><span style="color:#24292E;">on;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># index a.html</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> autoindex_exact_size </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> autoindex_format </span><span style="color:#24292E;">json;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> autoindex_localtime </span><span style="color:#24292E;">on;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="concat-模块-提升多个小文件性能" tabindex="-1">concat 模块：提升多个小文件性能 <a class="header-anchor" href="#concat-模块-提升多个小文件性能" aria-label="Permalink to &quot;concat 模块：提升多个小文件性能&quot;">​</a></h4><img src="`+As+'" style="zoom:80%;"><p>concat 模块的指令</p><img src="'+Ds+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">concat.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/error.log</span><span style="color:#79B8FF;"> debug</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">concat</span><span style="color:#E1E4E8;"> on;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/concat </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">concat_max_files</span><span style="color:#E1E4E8;"> 20;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">concat_types</span><span style="color:#E1E4E8;"> text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">concat_unique</span><span style="color:#E1E4E8;"> on;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">concat_delimiter</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;:::&#39;</span><span style="color:#E1E4E8;">; </span><span style="color:#6A737D;"># ::: 来分割多个文件</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">concat_ignore_file_error</span><span style="color:#E1E4E8;"> on;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">concat.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/error.log</span><span style="color:#005CC5;"> debug</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">concat</span><span style="color:#24292E;"> on;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/concat </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">concat_max_files</span><span style="color:#24292E;"> 20;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">concat_types</span><span style="color:#24292E;"> text/plain;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">concat_unique</span><span style="color:#24292E;"> on;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">concat_delimiter</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;:::&#39;</span><span style="color:#24292E;">; </span><span style="color:#6A737D;"># ::: 来分割多个文件</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">concat_ignore_file_error</span><span style="color:#24292E;"> on;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="log-阶段" tabindex="-1">log 阶段 <a class="header-anchor" href="#log-阶段" aria-label="Permalink to &quot;log 阶段&quot;">​</a></h3><h4 id="log-模块-记录请求访问日志" tabindex="-1">log 模块：记录请求访问日志 <a class="header-anchor" href="#log-模块-记录请求访问日志" aria-label="Permalink to &quot;log 模块：记录请求访问日志&quot;">​</a></h4><p>功能：将 HTTP 请求相关信息记录到日志</p><p>模块：ngx_http_log_module 无法禁用</p><p>access 日志格式</p><img src="`+Cs+'" style="zoom:80%;"><p>配置日志文件路径</p><img src="'+qs+'" style="zoom:80%;"><p>日志文件名包含变量时的优化</p><img src="'+Bs+'" style="zoom:80%;"><h3 id="http-过滤模块" tabindex="-1">HTTP 过滤模块 <a class="header-anchor" href="#http-过滤模块" aria-label="Permalink to &quot;HTTP 过滤模块&quot;">​</a></h3><p>介于 content 模块之后，log 模块之前介入请求处理。</p><img src="'+Ps+'" style="zoom:80%;"><p>返回响应-加工响应内容</p><img src="'+zs+'" style="zoom:80%;"><h4 id="sub-模块" tabindex="-1">sub 模块 <a class="header-anchor" href="#sub-模块" aria-label="Permalink to &quot;sub 模块&quot;">​</a></h4><p>替换响应中的字符串：sub 模块。ngx_http_sub_filter_module。</p><img src="'+ws+'" style="zoom:80%;"><p>sub 模块的指令。</p><img src="'+$s+`" style="zoom:80%;"><p>sub_fillter_last_modified：是否显示修改之前的 last_modified 内容，默认是关闭的。</p><p>sub_filter_once：只替换一次</p><p>sub_filter_types：针对什么类型进行替换，默认是 text/html。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">sub.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/error.log info;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># sub_filter &#39;Nginx.oRg&#39; &#39;$host/nginx&#39;;  # 替换时忽略大小写</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># sub_filter &#39;nginx.cOm&#39; &#39;$host/nginx&#39;;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># sub_filter_once on;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># sub_filter_once off;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># sub_filter_last_modifed off;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;"># sub_filter_last_modifed on;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">sub.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/error.log info;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># sub_filter &#39;Nginx.oRg&#39; &#39;$host/nginx&#39;;  # 替换时忽略大小写</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># sub_filter &#39;nginx.cOm&#39; &#39;$host/nginx&#39;;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># sub_filter_once on;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># sub_filter_once off;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># sub_filter_last_modifed off;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;"># sub_filter_last_modifed on;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="addition-模块" tabindex="-1">addition 模块 <a class="header-anchor" href="#addition-模块" aria-label="Permalink to &quot;addition 模块&quot;">​</a></h4><p>响应前或者响应后增加内容。</p><img src="`+Ts+'" style="zoom:80%;"><p>addition 模块的指令。</p><img src="'+js+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">addition.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/error.log info;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> add_before_body </span><span style="color:#E1E4E8;">/before_action;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> add_after_body </span><span style="color:#E1E4E8;">/after_action;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> addition_types </span><span style="color:#E1E4E8;">*;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/brefore_action </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;new content before</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/after_action </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;new content after</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/testhost </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> uninitialized_variable_warn </span><span style="color:#E1E4E8;">on;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> set </span><span style="color:#E1E4E8;">$foo </span><span style="color:#9ECBFF;">&#39;testhost&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;$</span><span style="color:#E1E4E8;">gzip_ratio</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">addition.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/error.log info;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> add_before_body </span><span style="color:#24292E;">/before_action;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> add_after_body </span><span style="color:#24292E;">/after_action;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> addition_types </span><span style="color:#24292E;">*;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/brefore_action </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;new content before</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/after_action </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;new content after</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/testhost </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> uninitialized_variable_warn </span><span style="color:#24292E;">on;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> set </span><span style="color:#24292E;">$foo </span><span style="color:#032F62;">&#39;testhost&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">gzip_ratio</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="nginx-变量的运行原理" tabindex="-1">Nginx 变量的运行原理 <a class="header-anchor" href="#nginx-变量的运行原理" aria-label="Permalink to &quot;Nginx 变量的运行原理&quot;">​</a></h3><h4 id="惰性求值" tabindex="-1">惰性求值 <a class="header-anchor" href="#惰性求值" aria-label="Permalink to &quot;惰性求值&quot;">​</a></h4><img src="`+Ns+'" style="zoom:80%;"><h4 id="变量的特性" tabindex="-1">变量的特性 <a class="header-anchor" href="#变量的特性" aria-label="Permalink to &quot;变量的特性&quot;">​</a></h4><ul><li>惰性求值</li><li>变量值可以时刻变化，其值为使用的那一刻的值</li></ul><h3 id="http-框架提供的请求相关的变量" tabindex="-1">HTTP 框架提供的请求相关的变量 <a class="header-anchor" href="#http-框架提供的请求相关的变量" aria-label="Permalink to &quot;HTTP 框架提供的请求相关的变量&quot;">​</a></h3><ul><li>HTTP 请求相关的变量</li><li>TCP 连接相关的变量</li><li>Nginx 处理请求过程中产生的变量</li><li>发送 HTTP 响应时相关的变量</li><li>Nginx 系统变量</li></ul><h4 id="http-请求相关的变量" tabindex="-1">HTTP 请求相关的变量 <a class="header-anchor" href="#http-请求相关的变量" aria-label="Permalink to &quot;HTTP 请求相关的变量&quot;">​</a></h4><table><thead><tr><th>参数</th><th>参数含义</th></tr></thead><tbody><tr><td>arg_参数名</td><td>URL 中某个具体参数的值</td></tr><tr><td>query_string</td><td>与 args 变量完全相同</td></tr><tr><td>args</td><td>全部 URL 参数</td></tr><tr><td>is_args</td><td>如果请求 URL 中有参数则返回 ？否则返回空</td></tr><tr><td>content_length</td><td>HTTP 请求中标识包体长度的 Content-Length 头部的值</td></tr><tr><td>content_type</td><td>标识请求包体类型的 Content-Type 头部的值</td></tr><tr><td>uri</td><td>请求的 URI （不同于 URL，不包括 ？后的参数）</td></tr><tr><td>document_uri</td><td>与 uri 完全相同</td></tr><tr><td>request_uri</td><td>请求的 URL（包括 URI 以及完整的参数）</td></tr><tr><td>scheme</td><td>协议名，例如 HTTP 或者 HTTPS</td></tr><tr><td>request_method</td><td>请求方法，例如 GET 或者 POST</td></tr><tr><td>request_length</td><td>所有请求内容的大小，包括请求行、头部、包体等</td></tr><tr><td>remote_user</td><td>由 HTTP Basic Authentication 协议传入的用户名</td></tr><tr><td>request_body_file</td><td>临时存放请求包体的文件（如果包体非常小不会存文件、client_body_in_file_body 强制所有包体存入文件，且可以决定是否删除）</td></tr><tr><td>request_body</td><td>请求中的包体，这个变量当且仅当使用反向代理，且设定用内存暂存包体时才有效</td></tr><tr><td>request</td><td>原始的 url 请求，含有方法与协议版本，例如 GET /?a=1&amp;b=22 HTTP/1.1</td></tr><tr><td>host</td><td>先从请求行中获取，如果含有 Host 头部，则用其值替换掉请求行中的主机名，如果前两者都取不到，则使用匹配上的 server_name</td></tr><tr><td>http_头部名字</td><td>返回一个具体请求头部的值（特殊：http_host、http_user_agent、http_referer、http_via、http_x_forward_for、http_cookie）</td></tr></tbody></table><h4 id="tcp-连接相关的变量" tabindex="-1">TCP 连接相关的变量 <a class="header-anchor" href="#tcp-连接相关的变量" aria-label="Permalink to &quot;TCP 连接相关的变量&quot;">​</a></h4><table><thead><tr><th>参数</th><th>参数含义</th></tr></thead><tbody><tr><td>binary_remote_addr</td><td>客户端地址的整型格式，对于 IPv4 是 4 字节，对于 IPv6 是 16 字节</td></tr><tr><td>connection</td><td>递增的连接序号</td></tr><tr><td>connection_requests</td><td>当前连接上执行过的请求数，对 keepalive 连接有意义</td></tr><tr><td>remote_addr</td><td>客户端地址</td></tr><tr><td>remote_port</td><td>客户端端口</td></tr><tr><td>proxy_protocol_addr</td><td>若使用 proxy_protocol 协议则返回协议中的地址，否则返回空</td></tr><tr><td>proxy_protocol_port</td><td>若使用 proxy_protocol 协议则返回协议中的端口，否则返回空</td></tr><tr><td>server_addr</td><td>服务端地址</td></tr><tr><td>server_port</td><td>服务端端口</td></tr><tr><td>TCP_INFO</td><td>tcp 内核层参数，包括 $tcpinfp_rtt，$tcpinfo_rttvar，$tcpinfo_snd_cwnd，$tcpinco_rcv_space</td></tr><tr><td>server_protocol</td><td>服务端协议，例如 HTTP/1.1</td></tr></tbody></table><h4 id="nginx-处理请求过程中产生的变量" tabindex="-1">Nginx 处理请求过程中产生的变量 <a class="header-anchor" href="#nginx-处理请求过程中产生的变量" aria-label="Permalink to &quot;Nginx 处理请求过程中产生的变量&quot;">​</a></h4><table><thead><tr><th>参数</th><th>参数含义</th></tr></thead><tbody><tr><td>request_time</td><td>请求处理到现在的耗时，单位为秒，精确到毫秒</td></tr><tr><td>server_name</td><td>匹配上请求的 server_name 值</td></tr><tr><td>https</td><td>如果开启了 TLS/SSL ，则返回 on，否则返回空</td></tr><tr><td>request_competion</td><td>如请求处理完则返回 OK，否则返回空</td></tr><tr><td>request_id</td><td>以 16 进制输出的请求标识 id，该 id 共含有 16 个字节，是随机生成的</td></tr><tr><td>request_filename</td><td>待访问文件的完整路径</td></tr><tr><td>document_root</td><td>由 URI 和 root/alias 规则生成的文件夹路径</td></tr><tr><td>realpath_root</td><td>将 document_root 中的软链接等换成真实路径</td></tr><tr><td>limit_rate</td><td>返回客户端响应时的速度上限，单位为每秒字节数。可以通过 set 指令修改对请求产生效果</td></tr></tbody></table><h4 id="发送-http-响应时相关的变量" tabindex="-1">发送 HTTP 响应时相关的变量 <a class="header-anchor" href="#发送-http-响应时相关的变量" aria-label="Permalink to &quot;发送 HTTP 响应时相关的变量&quot;">​</a></h4><table><thead><tr><th>参数</th><th>参数含义</th></tr></thead><tbody><tr><td>body_bytes_sent</td><td>响应中 body 包体的长度</td></tr><tr><td>byte_sent</td><td>全部 http 响应的长度</td></tr><tr><td>status</td><td>http 响应中的返回码</td></tr><tr><td>sent_trailer_名字</td><td>把响应结尾内容里值返回</td></tr><tr><td>request_id</td><td>以 16 进制输出的请求标识 id，该 id 共含有 16 个字节，是随机生成的</td></tr><tr><td>sent_http_头部名字</td><td>响应中某个具体头部的值</td></tr></tbody></table><p>特殊处理：</p><ul><li>sent_http_content_type</li><li>sent_http_content_length</li><li>sent_http_location</li><li>sent_http_last_modified</li><li>sent_http_connection</li><li>sent_http_keep_alive</li><li>sent_http_transfer_encoding</li><li>sent_http_cache_control</li><li>sent_http_link</li></ul><h4 id="nginx-系统变量" tabindex="-1">Nginx 系统变量 <a class="header-anchor" href="#nginx-系统变量" aria-label="Permalink to &quot;Nginx 系统变量&quot;">​</a></h4><table><thead><tr><th>参数</th><th>参数含义</th></tr></thead><tbody><tr><td>time_local</td><td>以本地时间标准输出的当前时间</td></tr><tr><td>time_iso8601</td><td>使用 ISO 8601 标准输出的当前事件</td></tr><tr><td>nginx_version</td><td>Nginx 版本号</td></tr><tr><td>pid</td><td>所属 worker 进程的进程 id</td></tr><tr><td>pipe</td><td>使用了管道则返回 p，否则返回 .</td></tr><tr><td>hostname</td><td>所在服务器的主机名，与 hostname 命令输出一致</td></tr><tr><td>msec</td><td>1970 年 1 月 1 日到现在的时间，单位为秒，小数点后精确到毫秒</td></tr></tbody></table><h3 id="referer-模块-变量防盗链" tabindex="-1">referer 模块：变量防盗链 <a class="header-anchor" href="#referer-模块-变量防盗链" aria-label="Permalink to &quot;referer 模块：变量防盗链&quot;">​</a></h3><h4 id="referer-模块" tabindex="-1">referer 模块 <a class="header-anchor" href="#referer-模块" aria-label="Permalink to &quot;referer 模块&quot;">​</a></h4><p>场景：某网站通过 url 引用了你的页面，当用户在浏览器上点击 url 时，http 请求的头部中会通过 referer 头部，将该网站当前页面的 url 带上，告诉服务器本次请求是否这个页面发起的。</p><p>目的：拒绝非正常的网站访问我们站点的资源</p><p>思路：通过 referer，用 invalid_referer 变量根据配置判断 referer 头部是否合法</p><p>referer 模块：默认编译进 Nginx，通过 --without-http_referer_module 禁用</p><h4 id="referer-模块的指令" tabindex="-1">referer 模块的指令 <a class="header-anchor" href="#referer-模块的指令" aria-label="Permalink to &quot;referer 模块的指令&quot;">​</a></h4><img src="'+Ss+'" style=""><h4 id="valid-referers-指令" tabindex="-1">valid_referers 指令 <a class="header-anchor" href="#valid-referers-指令" aria-label="Permalink to &quot;valid_referers 指令&quot;">​</a></h4><p>可同时携带多个参数，表示多个 referer 头部都生效</p><img src="'+Hs+'" style=""><h3 id="secure-link-变量实现防盗链" tabindex="-1">secure_link：变量实现防盗链 <a class="header-anchor" href="#secure-link-变量实现防盗链" aria-label="Permalink to &quot;secure_link：变量实现防盗链&quot;">​</a></h3><h4 id="secure-模块" tabindex="-1">secure 模块 <a class="header-anchor" href="#secure-模块" aria-label="Permalink to &quot;secure 模块&quot;">​</a></h4><img src="'+Rs+'" style=""><img src="'+Is+'" style=""><h4 id="变量值及带过期时间的配置" tabindex="-1">变量值及带过期时间的配置 <a class="header-anchor" href="#变量值及带过期时间的配置" aria-label="Permalink to &quot;变量值及带过期时间的配置&quot;">​</a></h4><p>变量</p><ul><li>secure_link <ul><li>值为空字符串：验证不通过</li><li>值为 0：URL 过期</li><li>值为 1：验证通过</li></ul></li><li>secure_link_expires <ul><li>时间戳的值</li></ul></li></ul><img src="'+Us+`" style=""><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> secure_link </span><span style="color:#E1E4E8;">$arg_md5,$arg_expires;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> secure_link_md5 </span><span style="color:#9ECBFF;">&quot;$</span><span style="color:#E1E4E8;">secure_link_expires</span><span style="color:#9ECBFF;">$</span><span style="color:#E1E4E8;">uri</span><span style="color:#9ECBFF;">$</span><span style="color:#E1E4E8;">remote_addr</span><span style="color:#9ECBFF;"> secret&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($secure_link </span><span style="color:#F97583;">= </span><span style="color:#9ECBFF;">&#39;0&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">410</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;$</span><span style="color:#E1E4E8;">secure_link</span><span style="color:#9ECBFF;">:$</span><span style="color:#E1E4E8;">secure_link_expires</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> secure_link </span><span style="color:#24292E;">$arg_md5,$arg_expires;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> secure_link_md5 </span><span style="color:#032F62;">&quot;$</span><span style="color:#24292E;">secure_link_expires</span><span style="color:#032F62;">$</span><span style="color:#24292E;">uri</span><span style="color:#032F62;">$</span><span style="color:#24292E;">remote_addr</span><span style="color:#032F62;"> secret&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($secure_link </span><span style="color:#D73A49;">= </span><span style="color:#032F62;">&#39;0&#39;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">410</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">secure_link</span><span style="color:#032F62;">:$</span><span style="color:#24292E;">secure_link_expires</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h4 id="仅对-uri-进行哈希" tabindex="-1">仅对 URI 进行哈希 <a class="header-anchor" href="#仅对-uri-进行哈希" aria-label="Permalink to &quot;仅对 URI 进行哈希&quot;">​</a></h4><ul><li>将请求 URL 分为三部分，<code>/prefix/hash/link</code></li><li>Hash 生成方式 <ul><li>对 “link 密钥” 做 md5 哈希值</li></ul></li><li>用 secure_link_secret secret; 配置密钥</li></ul><img src="`+Ls+`" style=""><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/p/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> secure_link_secret </span><span style="color:#E1E4E8;">mysecret2;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> ($secure_link </span><span style="color:#F97583;">= </span><span style="color:#9ECBFF;">&quot; &quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">403</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">rewrite</span><span style="color:#E1E4E8;"> </span><span style="color:#DBEDFF;">^ /secure/$</span><span style="color:#E1E4E8;">secure_link;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/secure/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> alias </span><span style="color:#E1E4E8;">html/;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">internal</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/p/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> secure_link_secret </span><span style="color:#24292E;">mysecret2;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> ($secure_link </span><span style="color:#D73A49;">= </span><span style="color:#032F62;">&quot; &quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">403</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">rewrite</span><span style="color:#24292E;"> </span><span style="color:#032F62;">^ /secure/$</span><span style="color:#24292E;">secure_link;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/secure/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> alias </span><span style="color:#24292E;">html/;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">internal</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="map-模块-为复杂业务生成新变量" tabindex="-1">map 模块：为复杂业务生成新变量 <a class="header-anchor" href="#map-模块-为复杂业务生成新变量" aria-label="Permalink to &quot;map 模块：为复杂业务生成新变量&quot;">​</a></h3><p>可以根据一个或者多个变量组合而成的值做判断，修改新的变量的值，通过判断新变量的值实现复杂的业务逻辑。</p><img src="`+Os+'" style=""><img src="'+Xs+'" style=""><img src="'+Gs+`" style=""><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">map</span><span style="color:#E1E4E8;"> $</span><span style="color:#FFAB70;">http_host</span><span style="color:#E1E4E8;"> $name {</span></span>
<span class="line"><span style="color:#E1E4E8;">  hostnames;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;"> default</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">~</span><span style="color:#E1E4E8;">map</span><span style="color:#F97583;">\\.tao\\w+\\.org.cn 1; *.taohui.org.cn   2; map.taohui.tech   3; map.taohui.*    </span><span style="color:#E1E4E8;">4;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">map</span><span style="color:#E1E4E8;"> $</span><span style="color:#FFAB70;">http_user_agent</span><span style="color:#E1E4E8;"> $mobile { </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;"> default</span><span style="color:#E1E4E8;">       </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;~Opera Mini&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8080;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;$</span><span style="color:#E1E4E8;">name</span><span style="color:#9ECBFF;">:$</span><span style="color:#E1E4E8;">mobile</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">map</span><span style="color:#24292E;"> $</span><span style="color:#E36209;">http_host</span><span style="color:#24292E;"> $name {</span></span>
<span class="line"><span style="color:#24292E;">  hostnames;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#005CC5;"> default</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">~</span><span style="color:#24292E;">map</span><span style="color:#D73A49;">\\.tao\\w+\\.org.cn 1; *.taohui.org.cn   2; map.taohui.tech   3; map.taohui.*    </span><span style="color:#24292E;">4;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">map</span><span style="color:#24292E;"> $</span><span style="color:#E36209;">http_user_agent</span><span style="color:#24292E;"> $mobile { </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;"> default</span><span style="color:#24292E;">       </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;~Opera Mini&quot;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8080;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">name</span><span style="color:#032F62;">:$</span><span style="color:#24292E;">mobile</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="split-client-模块-指定少量用户实现-ab-测试" tabindex="-1">split_client 模块：指定少量用户实现 AB 测试 <a class="header-anchor" href="#split-client-模块-指定少量用户实现-ab-测试" aria-label="Permalink to &quot;split_client 模块：指定少量用户实现 AB 测试&quot;">​</a></h3><img src="`+Ms+'" style="zoom:80%;"><img src="'+Ws+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">split_clients </span><span style="color:#9ECBFF;">&quot;\${</span><span style="color:#E1E4E8;">http_testcli</span><span style="color:#9ECBFF;">}&quot;</span><span style="color:#E1E4E8;"> $variant {</span></span>
<span class="line"><span style="color:#E1E4E8;">  0.51% .one;</span></span>
<span class="line"><span style="color:#E1E4E8;">  20.0% .two;</span></span>
<span class="line"><span style="color:#E1E4E8;">  50.5% .three;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># 40%   .four; 超过 100 不能访问</span></span>
<span class="line"><span style="color:#E1E4E8;">  *     &quot;&quot;;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">split_clients.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/error.log</span><span style="color:#79B8FF;"> debug</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  	</span><span style="color:#F97583;">rteurn</span><span style="color:#E1E4E8;"> 200 </span><span style="color:#9ECBFF;">&#39;ABtestfile$</span><span style="color:#E1E4E8;">variant</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;  </span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">split_clients </span><span style="color:#032F62;">&quot;\${</span><span style="color:#24292E;">http_testcli</span><span style="color:#032F62;">}&quot;</span><span style="color:#24292E;"> $variant {</span></span>
<span class="line"><span style="color:#24292E;">  0.51% .one;</span></span>
<span class="line"><span style="color:#24292E;">  20.0% .two;</span></span>
<span class="line"><span style="color:#24292E;">  50.5% .three;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># 40%   .four; 超过 100 不能访问</span></span>
<span class="line"><span style="color:#24292E;">  *     &quot;&quot;;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">split_clients.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/error.log</span><span style="color:#005CC5;"> debug</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  	</span><span style="color:#D73A49;">rteurn</span><span style="color:#24292E;"> 200 </span><span style="color:#032F62;">&#39;ABtestfile$</span><span style="color:#24292E;">variant</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;  </span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">curl </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">H</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;testcli: 213213231adadasdad&#39;</span><span style="color:#E1E4E8;"> split_clients.yueluo.club</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">curl </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;testcli: 213213231adadasdad&#39;</span><span style="color:#24292E;"> split_clients.yueluo.club</span></span></code></pre></div><h3 id="geo-模块-根据-ip-范围的匹配生成新变量" tabindex="-1">geo 模块：根据 IP 范围的匹配生成新变量 <a class="header-anchor" href="#geo-模块-根据-ip-范围的匹配生成新变量" aria-label="Permalink to &quot;geo 模块：根据 IP 范围的匹配生成新变量&quot;">​</a></h3><img src="`+Ks+'" style="zoom:80%;"><img src="'+Vs+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">geo </span><span style="color:#E1E4E8;">$country {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;"> default</span><span style="color:#E1E4E8;">        ZZ;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># include        conf/geo.conf;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">proxy</span><span style="color:#E1E4E8;">          116.62.160.193;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  127.0.0.0/</span><span style="color:#F97583;">24</span><span style="color:#E1E4E8;">   US;</span></span>
<span class="line"><span style="color:#E1E4E8;">  127.0.0.1/</span><span style="color:#F97583;">32</span><span style="color:#E1E4E8;">   RU;</span></span>
<span class="line"><span style="color:#E1E4E8;">  10.1.0.0/</span><span style="color:#F97583;">16</span><span style="color:#E1E4E8;">    RU;</span></span>
<span class="line"><span style="color:#E1E4E8;">  192.168.1.0/</span><span style="color:#F97583;">24</span><span style="color:#E1E4E8;"> UK; </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">geo.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;$</span><span style="color:#E1E4E8;">country</span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">geo </span><span style="color:#24292E;">$country {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#005CC5;"> default</span><span style="color:#24292E;">        ZZ;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># include        conf/geo.conf;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">proxy</span><span style="color:#24292E;">          116.62.160.193;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  127.0.0.0/</span><span style="color:#D73A49;">24</span><span style="color:#24292E;">   US;</span></span>
<span class="line"><span style="color:#24292E;">  127.0.0.1/</span><span style="color:#D73A49;">32</span><span style="color:#24292E;">   RU;</span></span>
<span class="line"><span style="color:#24292E;">  10.1.0.0/</span><span style="color:#D73A49;">16</span><span style="color:#24292E;">    RU;</span></span>
<span class="line"><span style="color:#24292E;">  192.168.1.0/</span><span style="color:#D73A49;">24</span><span style="color:#24292E;"> UK; </span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">geo.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;$</span><span style="color:#24292E;">country</span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="geoip-模块-获取用户地理位置" tabindex="-1">geoip 模块：获取用户地理位置 <a class="header-anchor" href="#geoip-模块-获取用户地理位置" aria-label="Permalink to &quot;geoip 模块：获取用户地理位置&quot;">​</a></h3><h5 id="基于-maxmind-数据库从客户端获取变量" tabindex="-1">基于 MaxMind 数据库从客户端获取变量 <a class="header-anchor" href="#基于-maxmind-数据库从客户端获取变量" aria-label="Permalink to &quot;基于 MaxMind 数据库从客户端获取变量&quot;">​</a></h5><img src="`+Zs+'" style="zoom:80%;"><h4 id="geoip-country-指令提供的变量" tabindex="-1">geoip_country 指令提供的变量 <a class="header-anchor" href="#geoip-country-指令提供的变量" aria-label="Permalink to &quot;geoip_country 指令提供的变量&quot;">​</a></h4><img src="'+Qs+'" style="zoom:80%;"><h4 id="geoip-city-指令提供的变量" tabindex="-1">geoip_city 指令提供的变量 <a class="header-anchor" href="#geoip-city-指令提供的变量" aria-label="Permalink to &quot;geoip_city 指令提供的变量&quot;">​</a></h4><img src="'+Ys+'" style="zoom:80%;"><img src="'+Js+`" style="zoom:80%;"><p>maxmind 网站，下载 c 语言代码库和地址库，对它进行编译。</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">geoip_country </span><span style="color:#E1E4E8;">/usr/local/share/GeoIP/GeoIP.dat;</span></span>
<span class="line"><span style="color:#F97583;">geoip_city </span><span style="color:#E1E4E8;">/usr/local/share/GeoIP/GeoLiteCity.dat;</span></span>
<span class="line"><span style="color:#F97583;">geoip_proxy </span><span style="color:#E1E4E8;">116.62.160.193/32;</span></span>
<span class="line"><span style="color:#F97583;">geoip_proxy_recursize</span><span style="color:#E1E4E8;"> on;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;country:$</span><span style="color:#E1E4E8;">geoip_country_code</span><span style="color:#9ECBFF;">&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">geoip_country </span><span style="color:#24292E;">/usr/local/share/GeoIP/GeoIP.dat;</span></span>
<span class="line"><span style="color:#D73A49;">geoip_city </span><span style="color:#24292E;">/usr/local/share/GeoIP/GeoLiteCity.dat;</span></span>
<span class="line"><span style="color:#D73A49;">geoip_proxy </span><span style="color:#24292E;">116.62.160.193/32;</span></span>
<span class="line"><span style="color:#D73A49;">geoip_proxy_recursize</span><span style="color:#24292E;"> on;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;country:$</span><span style="color:#24292E;">geoip_country_code</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">curl </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">H</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;X-Forwarded-For: ip&#39;</span><span style="color:#E1E4E8;"> geoip.yueluo.club</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">curl </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">H</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;X-Forwarded-For: ip&#39;</span><span style="color:#24292E;"> geoip.yueluo.club</span></span></code></pre></div><h3 id="对客户端使用-keeplive-提升连接效率" tabindex="-1">对客户端使用 keeplive 提升连接效率 <a class="header-anchor" href="#对客户端使用-keeplive-提升连接效率" aria-label="Permalink to &quot;对客户端使用 keeplive 提升连接效率&quot;">​</a></h3><p>http 协议的 keepalive，不是指 tcp 协议的 keepalive。</p><img src="`+sa+'" style="zoom:80%;"><img src="'+aa+'" style="zoom:80%;"><h2 id="四、反向代理与负载均衡" tabindex="-1">四、反向代理与负载均衡 <a class="header-anchor" href="#四、反向代理与负载均衡" aria-label="Permalink to &quot;四、反向代理与负载均衡&quot;">​</a></h2><h3 id="反向代理与负载均衡原理" tabindex="-1">反向代理与负载均衡原理 <a class="header-anchor" href="#反向代理与负载均衡原理" aria-label="Permalink to &quot;反向代理与负载均衡原理&quot;">​</a></h3><h4 id="负载均衡" tabindex="-1">负载均衡 <a class="header-anchor" href="#负载均衡" aria-label="Permalink to &quot;负载均衡&quot;">​</a></h4><img src="'+na+'" style="zoom:80%;"><h4 id="nginx-在-akf-扩展立方体上的应用" tabindex="-1">nginx 在 AKF 扩展立方体上的应用 <a class="header-anchor" href="#nginx-在-akf-扩展立方体上的应用" aria-label="Permalink to &quot;nginx 在 AKF 扩展立方体上的应用&quot;">​</a></h4><img src="'+la+'" style="zoom:80%;"><h4 id="支持多种协议的反向代理" tabindex="-1">支持多种协议的反向代理 <a class="header-anchor" href="#支持多种协议的反向代理" aria-label="Permalink to &quot;支持多种协议的反向代理&quot;">​</a></h4><img src="'+pa+'" style="zoom:80%;"><h4 id="反向代理与缓存" tabindex="-1">反向代理与缓存 <a class="header-anchor" href="#反向代理与缓存" aria-label="Permalink to &quot;反向代理与缓存&quot;">​</a></h4><img src="'+oa+'" style="zoom:80%;"><h3 id="负载均衡算法-round-robin-算法" tabindex="-1">负载均衡算法：round-robin 算法 <a class="header-anchor" href="#负载均衡算法-round-robin-算法" aria-label="Permalink to &quot;负载均衡算法：round-robin 算法&quot;">​</a></h3><p>round-robin 算法 所有负载均衡算法的基础。其他负载均衡算法失效时，降级都是 round-robin 算法。</p><h4 id="指定上游服务器的-upstream-与-server-指令" tabindex="-1">指定上游服务器的 upstream 与 server 指令 <a class="header-anchor" href="#指定上游服务器的-upstream-与-server-指令" aria-label="Permalink to &quot;指定上游服务器的 upstream 与 server 指令&quot;">​</a></h4><img src="'+ea+'" style="zoom:80%;"><img src="'+ta+'" style="zoom:80%;"><h4 id="加权-round-robin-负载均衡算法" tabindex="-1">加权 Round-Robin 负载均衡算法 <a class="header-anchor" href="#加权-round-robin-负载均衡算法" aria-label="Permalink to &quot;加权 Round-Robin 负载均衡算法&quot;">​</a></h4><p>Rounb-Robin：依次执行，轮询的方式</p><img src="'+ra+'" style="zoom:80%;"><h4 id="对上游服务使用-keep-alive-长连接" tabindex="-1">对上游服务使用 keep-alive 长连接 <a class="header-anchor" href="#对上游服务使用-keep-alive-长连接" aria-label="Permalink to &quot;对上游服务使用 keep-alive 长连接&quot;">​</a></h4><img src="'+ca+'" style="zoom:80%;"><h4 id="upstream-keepalive-指令" tabindex="-1">upstream_keepalive 指令 <a class="header-anchor" href="#upstream-keepalive-指令" aria-label="Permalink to &quot;upstream_keepalive 指令&quot;">​</a></h4><img src="'+ia+'" style="zoom:80%;"><h4 id="指定上游服务器域名解析的-resolver-指令" tabindex="-1">指定上游服务器域名解析的 resolver 指令 <a class="header-anchor" href="#指定上游服务器域名解析的-resolver-指令" aria-label="Permalink to &quot;指定上游服务器域名解析的 resolver 指令&quot;">​</a></h4><img src="'+Ea+`" style="zoom:80%;"><p>upserver.config</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8011;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;8011 server response. </span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8012;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># client_body_in_single_buffer on;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;8012 server response. </span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8011;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;8011 server response. </span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8012;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># client_body_in_single_buffer on;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;8012 server response. </span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>rrups.config</p><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">rrups </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8011 </span><span style="color:#FFAB70;">weight</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> max_conns=2 </span><span style="color:#FFAB70;">max_fails</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> fail_timeout=5;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8012;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> keepalive </span><span style="color:#E1E4E8;">32;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">rrups.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">/logs/error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">https://rrups;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_http_version </span><span style="color:#E1E4E8;">1;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">Connection </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">rrups </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8011 </span><span style="color:#E36209;">weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> max_conns=2 </span><span style="color:#E36209;">max_fails</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> fail_timeout=5;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8012;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> keepalive </span><span style="color:#24292E;">32;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">rrups.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">/logs/error.log;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">https://rrups;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_http_version </span><span style="color:#24292E;">1;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Connection </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="负载均衡算法哈希算法-ip-hash-与-hash-模块" tabindex="-1">负载均衡算法哈希算法：ip_hash 与 hash 模块 <a class="header-anchor" href="#负载均衡算法哈希算法-ip-hash-与-hash-模块" aria-label="Permalink to &quot;负载均衡算法哈希算法：ip_hash 与 hash 模块&quot;">​</a></h3><h4 id="upstream-ip-hash-模块" tabindex="-1">upstream_ip_hash 模块 <a class="header-anchor" href="#upstream-ip-hash-模块" aria-label="Permalink to &quot;upstream_ip_hash 模块&quot;">​</a></h4><p>基于客户端 IP 地址的 Hash 算法实现负载均衡。</p><img src="`+ya+'" style="zoom:80%;"><h4 id="upstaream-hash-模块" tabindex="-1">upstaream_hash 模块 <a class="header-anchor" href="#upstaream-hash-模块" aria-label="Permalink to &quot;upstaream_hash 模块&quot;">​</a></h4><img src="'+da+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">iphashups </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">ip_hash</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;"># hash user_$arg_username;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8011 </span><span style="color:#FFAB70;">weight</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> max_conns=2 </span><span style="color:#FFAB70;">max_fails</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> fail_timeout=5;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8012 </span><span style="color:#FFAB70;">weight</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">server {</span></span>
<span class="line"><span style="color:#E1E4E8;">  set_real_ip_from </span><span style="color:#79B8FF;">116.62.160.193</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">real_ip_recursize</span><span style="color:#E1E4E8;"> on;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> real_ip_header </span><span style="color:#E1E4E8;">X-Forwared-For;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">iphash.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#F97583;">	error_log </span><span style="color:#E1E4E8;">logs/error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> access_log </span><span style="color:#E1E4E8;">logs/access.log;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://iphashups;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_http_version </span><span style="color:#E1E4E8;">1.1;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">Connection </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">iphashups </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">ip_hash</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;"># hash user_$arg_username;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8011 </span><span style="color:#E36209;">weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> max_conns=2 </span><span style="color:#E36209;">max_fails</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> fail_timeout=5;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8012 </span><span style="color:#E36209;">weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">server {</span></span>
<span class="line"><span style="color:#24292E;">  set_real_ip_from </span><span style="color:#005CC5;">116.62.160.193</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">real_ip_recursize</span><span style="color:#24292E;"> on;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> real_ip_header </span><span style="color:#24292E;">X-Forwared-For;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">iphash.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#D73A49;">	error_log </span><span style="color:#24292E;">logs/error.log;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> access_log </span><span style="color:#24292E;">logs/access.log;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://iphashups;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_http_version </span><span style="color:#24292E;">1.1;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Connection </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="一致性-hash-算法-hash-模块" tabindex="-1">一致性 Hash 算法：Hash 模块 <a class="header-anchor" href="#一致性-hash-算法-hash-模块" aria-label="Permalink to &quot;一致性 Hash 算法：Hash 模块&quot;">​</a></h3><h4 id="hash-算法的问题" tabindex="-1">Hash 算法的问题 <a class="header-anchor" href="#hash-算法的问题" aria-label="Permalink to &quot;Hash 算法的问题&quot;">​</a></h4><img src="`+ha+'" style="zoom:80%;"><h4 id="宕机或者扩容时-hash-算法引发大量路由变更-导致缓存大范围失效" tabindex="-1">宕机或者扩容时，hash 算法引发大量路由变更，导致缓存大范围失效 <a class="header-anchor" href="#宕机或者扩容时-hash-算法引发大量路由变更-导致缓存大范围失效" aria-label="Permalink to &quot;宕机或者扩容时，hash 算法引发大量路由变更，导致缓存大范围失效&quot;">​</a></h4><img src="'+ua+'" style="zoom:80%;"><h4 id="一致性-hash-算法" tabindex="-1">一致性 Hash 算法 <a class="header-anchor" href="#一致性-hash-算法" aria-label="Permalink to &quot;一致性 Hash 算法&quot;">​</a></h4><p><strong>扩容前：</strong></p><img src="'+ga+'" style="zoom:80%;"><p><strong>扩容后：</strong></p><img src="'+_a+'" style="zoom:80%;"><h4 id="使用一致性-hash-算法-upstream-hash-模块" tabindex="-1">使用一致性 Hash 算法：upstream_hash 模块 <a class="header-anchor" href="#使用一致性-hash-算法-upstream-hash-模块" aria-label="Permalink to &quot;使用一致性 Hash 算法：upstream_hash 模块&quot;">​</a></h4><p>原有基础上增加配置 <code>[consistent]</code></p><img src="'+ma+'" style="zoom:80%;"><h3 id="最少连接算法以及如何跨-worker-进程生效" tabindex="-1">最少连接算法以及如何跨 worker 进程生效 <a class="header-anchor" href="#最少连接算法以及如何跨-worker-进程生效" aria-label="Permalink to &quot;最少连接算法以及如何跨 worker 进程生效&quot;">​</a></h3><h4 id="upstream-least-conn-模块" tabindex="-1">upstream_least_conn 模块 <a class="header-anchor" href="#upstream-least-conn-模块" aria-label="Permalink to &quot;upstream_least_conn 模块&quot;">​</a></h4><p>优先选择连接最少的上游服务器。</p><img src="'+Fa+'" style="zoom:80%;"><h4 id="upstream-zone-模块" tabindex="-1">upstream_zone 模块 <a class="header-anchor" href="#upstream-zone-模块" aria-label="Permalink to &quot;upstream_zone 模块&quot;">​</a></h4><p>使用共享内存使负载均衡对所有 worker 进程生效。</p><img src="'+ba+'" style="zoom:80%;"><h4 id="upstream-模块间的顺序-功能正常运行" tabindex="-1">upstream 模块间的顺序：功能正常运行 <a class="header-anchor" href="#upstream-模块间的顺序-功能正常运行" aria-label="Permalink to &quot;upstream 模块间的顺序：功能正常运行&quot;">​</a></h4><img src="'+xa+'" style="zoom:80%;"><h3 id="upstream-模块提供的变量-不含-cache" tabindex="-1">upstream 模块提供的变量（不含 cache） <a class="header-anchor" href="#upstream-模块提供的变量-不含-cache" aria-label="Permalink to &quot;upstream 模块提供的变量（不含 cache）&quot;">​</a></h3><table><thead><tr><th>变量</th><th>含义</th></tr></thead><tbody><tr><td>upstream_addr</td><td>上游服务器的 IP 地址，格式为可读的字符串，例如 127.0.0.1: 8012</td></tr><tr><td>upstream_connect_time</td><td>与上游服务器建立连接消耗的时间，单位为秒，精确到毫秒</td></tr><tr><td>upstream_header_time</td><td>接收上游服务发回响应中 http 头部所消耗的时间，单位为秒，精确到毫秒</td></tr><tr><td>upstream_response_time</td><td>接收完整的上游服务响应所消耗的时间，单位为秒，精确到毫秒</td></tr><tr><td>upstream_http_名称</td><td>从上游服务返回的响应头部的值</td></tr><tr><td>upstream_bytes_received</td><td>从上游服务接收到的响应长度，单位为字节</td></tr><tr><td>upstream_response_length</td><td>从上游服务返回的响应包体长度，单位为字节</td></tr><tr><td>upstream_status</td><td>上游服务返回的 HTTP 响应中的状态码。如果未连接上，该变量值为 502</td></tr><tr><td>upstream_cookie_名称</td><td>从上游服务器发回的响应头 Set-Cookie 中取出的 cookie 值</td></tr><tr><td>upstream_trailer_名称</td><td>从上游服务的响应尾部取到的值</td></tr></tbody></table><h3 id="proxy-模块处理请求的流程" tabindex="-1">proxy 模块处理请求的流程 <a class="header-anchor" href="#proxy-模块处理请求的流程" aria-label="Permalink to &quot;proxy 模块处理请求的流程&quot;">​</a></h3><img src="'+va+'" style="zoom:80%;"><h3 id="proxy-模块中的-proxy-pass-指令" tabindex="-1">proxy 模块中的 proxy_pass 指令 <a class="header-anchor" href="#proxy-模块中的-proxy-pass-指令" aria-label="Permalink to &quot;proxy 模块中的 proxy_pass 指令&quot;">​</a></h3><h4 id="http-协议的反向代理-proxy-模块" tabindex="-1">HTTP 协议的反向代理：proxy 模块 <a class="header-anchor" href="#http-协议的反向代理-proxy-模块" aria-label="Permalink to &quot;HTTP 协议的反向代理：proxy 模块&quot;">​</a></h4><img src="'+ka+'" style="zoom:80%;"><img src="'+fa+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8011;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;8011 server response. </span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8012;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;8012 server response. uri：$</span><span style="color:#E1E4E8;">uri</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8011;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;8011 server response. </span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8012;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;8012 server response. uri：$</span><span style="color:#24292E;">uri</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">proxyups </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8012 </span><span style="color:#FFAB70;">weight</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">server {</span></span>
<span class="line"><span style="color:#E1E4E8;">  server_name proxy.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> access_log </span><span style="color:#E1E4E8;">logs/upstream_access.log varups;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/a </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://proxyups/addurl;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">proxyups </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8012 </span><span style="color:#E36209;">weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">server {</span></span>
<span class="line"><span style="color:#24292E;">  server_name proxy.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/error.log;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> access_log </span><span style="color:#24292E;">logs/upstream_access.log varups;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/a </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://proxyups/addurl;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">proxy_pass </span><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//proxyups/addurl;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">curl proxy.yueluo.club</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">a</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">b</span><span style="color:#F97583;">/</span><span style="color:#FFAB70;">c</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> uri：</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">a</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">b</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">c</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">proxy_pass </span><span style="color:#6F42C1;">http</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//proxyups/addurl;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">curl proxy.yueluo.club</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">a</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">b</span><span style="color:#D73A49;">/</span><span style="color:#E36209;">c</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> uri：</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">a</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">b</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">c</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">proxy_pass </span><span style="color:#B392F0;">http</span><span style="color:#E1E4E8;">:</span><span style="color:#6A737D;">//proxyups/addurl/www;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">curl proxy.yueluo.club</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">a</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">b</span><span style="color:#F97583;">/</span><span style="color:#FFAB70;">c</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> uri：</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">www</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">b</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">c</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">proxy_pass </span><span style="color:#6F42C1;">http</span><span style="color:#24292E;">:</span><span style="color:#6A737D;">//proxyups/addurl/www;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">curl proxy.yueluo.club</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">a</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">b</span><span style="color:#D73A49;">/</span><span style="color:#E36209;">c</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> uri：</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">www</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">b</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">c</span></span></code></pre></div><p>proxy_pass 是动作类指令，指定某个阶段使用 proxy 模块处理请求，proxy_pass 是否加 url 可能产生不同的结果。</p><h3 id="根据指令修改发往上游的请求" tabindex="-1">根据指令修改发往上游的请求 <a class="header-anchor" href="#根据指令修改发往上游的请求" aria-label="Permalink to &quot;根据指令修改发往上游的请求&quot;">​</a></h3><h4 id="proxy-模块-生成发往上游的请求行" tabindex="-1">proxy 模块：生成发往上游的请求行 <a class="header-anchor" href="#proxy-模块-生成发往上游的请求行" aria-label="Permalink to &quot;proxy 模块：生成发往上游的请求行&quot;">​</a></h4><img src="`+Aa+'" style="zoom:80%;"><h4 id="proxy-模块-生成发往上游的请求头部" tabindex="-1">proxy 模块：生成发往上游的请求头部 <a class="header-anchor" href="#proxy-模块-生成发往上游的请求头部" aria-label="Permalink to &quot;proxy 模块：生成发往上游的请求头部&quot;">​</a></h4><img src="'+Da+'" style="zoom:80%;"><h4 id="proxy-模块-生成发往上游的包体" tabindex="-1">proxy 模块：生成发往上游的包体 <a class="header-anchor" href="#proxy-模块-生成发往上游的包体" aria-label="Permalink to &quot;proxy 模块：生成发往上游的包体&quot;">​</a></h4><img src="'+Ca+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8011;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;8011 server response. </span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8012;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;8012 server response. $</span><span style="color:#E1E4E8;">uri</span><span style="color:#9ECBFF;"> $</span><span style="color:#E1E4E8;">request_method</span><span style="color:#9ECBFF;"> $</span><span style="color:#E1E4E8;">request</span><span style="color:#9ECBFF;"> $</span><span style="color:#E1E4E8;">http_name</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">\\n</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8011;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;8011 server response. </span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8012;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;8012 server response. $</span><span style="color:#24292E;">uri</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">request_method</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">request</span><span style="color:#032F62;"> $</span><span style="color:#24292E;">http_name</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">\\n</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">proxyups </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8012 </span><span style="color:#FFAB70;">weight</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">server {</span></span>
<span class="line"><span style="color:#E1E4E8;">  server_name proxy.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/error.log;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> access_log </span><span style="color:#E1E4E8;">logs/upstream_access.log varups;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/a </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://proxyups/addurl;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_method </span><span style="color:#E1E4E8;">POST;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass_request_headers </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass_request_body </span><span style="color:#E1E4E8;">off;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_body </span><span style="color:#9ECBFF;">&#39;hello-wrold&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">name </span><span style="color:#9ECBFF;">&#39;&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_http_version </span><span style="color:#E1E4E8;">1.1;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_set_header </span><span style="color:#E1E4E8;">Connection </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">proxyups </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8012 </span><span style="color:#E36209;">weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">server {</span></span>
<span class="line"><span style="color:#24292E;">  server_name proxy.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/error.log;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> access_log </span><span style="color:#24292E;">logs/upstream_access.log varups;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/a </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://proxyups/addurl;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_method </span><span style="color:#24292E;">POST;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass_request_headers </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass_request_body </span><span style="color:#24292E;">off;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_body </span><span style="color:#032F62;">&#39;hello-wrold&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">name </span><span style="color:#032F62;">&#39;&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_http_version </span><span style="color:#24292E;">1.1;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_set_header </span><span style="color:#24292E;">Connection </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="接收用户请求包体的方式" tabindex="-1">接收用户请求包体的方式 <a class="header-anchor" href="#接收用户请求包体的方式" aria-label="Permalink to &quot;接收用户请求包体的方式&quot;">​</a></h3><h4 id="接收客户端请求的包体-收完再转发还是边收变转发" tabindex="-1">接收客户端请求的包体：收完再转发还是边收变转发 <a class="header-anchor" href="#接收客户端请求的包体-收完再转发还是边收变转发" aria-label="Permalink to &quot;接收客户端请求的包体：收完再转发还是边收变转发&quot;">​</a></h4><img src="`+qa+'" style="zoom:80%;"><h4 id="客户端包体的接收" tabindex="-1">客户端包体的接收 <a class="header-anchor" href="#客户端包体的接收" aria-label="Permalink to &quot;客户端包体的接收&quot;">​</a></h4><img src="'+Ba+'" style="zoom:80%;"><h4 id="最大包体长度限制" tabindex="-1">最大包体长度限制 <a class="header-anchor" href="#最大包体长度限制" aria-label="Permalink to &quot;最大包体长度限制&quot;">​</a></h4><img src="'+Pa+'" style="zoom:80%;"><h4 id="临时文件路径格式" tabindex="-1">临时文件路径格式 <a class="header-anchor" href="#临时文件路径格式" aria-label="Permalink to &quot;临时文件路径格式&quot;">​</a></h4><img src="'+za+'" style="zoom:80%;"><h4 id="读取包体的超时" tabindex="-1">读取包体的超时 <a class="header-anchor" href="#读取包体的超时" aria-label="Permalink to &quot;读取包体的超时&quot;">​</a></h4><img src="'+wa+'" style="zoom:80%;"><h3 id="与上游服务器建立连接" tabindex="-1">与上游服务器建立连接 <a class="header-anchor" href="#与上游服务器建立连接" aria-label="Permalink to &quot;与上游服务器建立连接&quot;">​</a></h3><h4 id="与上游服务器建立连接-1" tabindex="-1">与上游服务器建立连接 <a class="header-anchor" href="#与上游服务器建立连接-1" aria-label="Permalink to &quot;与上游服务器建立连接&quot;">​</a></h4><img src="'+$a+'" style="zoom:80%;"><p>当出现状态码 502 时，可以换一个服务器继续处理，通过 proxy_next_upstream。</p><h4 id="上游连接启动-tcp-keepalive" tabindex="-1">上游连接启动 TCP keepalive <a class="header-anchor" href="#上游连接启动-tcp-keepalive" aria-label="Permalink to &quot;上游连接启动 TCP keepalive&quot;">​</a></h4><img src="'+Ta+'" style="zoom:80%;"><h4 id="上游连接启用-http-keepalive" tabindex="-1">上游连接启用 HTTP keepalive <a class="header-anchor" href="#上游连接启用-http-keepalive" aria-label="Permalink to &quot;上游连接启用 HTTP keepalive&quot;">​</a></h4><img src="'+ja+'" style="zoom:80%;"><h4 id="修改-tcp-连接中的-local-address" tabindex="-1">修改 TCP 连接中的 local address <a class="header-anchor" href="#修改-tcp-连接中的-local-address" aria-label="Permalink to &quot;修改 TCP 连接中的 local address&quot;">​</a></h4><img src="'+Na+'" style="zoom:80%;"><h4 id="当客户端关闭连接时" tabindex="-1">当客户端关闭连接时 <a class="header-anchor" href="#当客户端关闭连接时" aria-label="Permalink to &quot;当客户端关闭连接时&quot;">​</a></h4><img src="'+Sa+'" style="zoom:80%;"><h3 id="接收上游的响应" tabindex="-1">接收上游的响应 <a class="header-anchor" href="#接收上游的响应" aria-label="Permalink to &quot;接收上游的响应&quot;">​</a></h3><h4 id="接收上游的-http-响应头部" tabindex="-1">接收上游的 HTTP 响应头部 <a class="header-anchor" href="#接收上游的-http-响应头部" aria-label="Permalink to &quot;接收上游的 HTTP 响应头部&quot;">​</a></h4><p>限定了上游 server 最大值。</p><img src="'+Ha+'" style="zoom:80%;"><h4 id="接收上游的-http-包体" tabindex="-1">接收上游的 HTTP 包体 <a class="header-anchor" href="#接收上游的-http-包体" aria-label="Permalink to &quot;接收上游的 HTTP 包体&quot;">​</a></h4><img src="'+Ra+'" style="zoom:80%;"><img src="'+Ia+'" style="zoom:80%;"><h4 id="及时转发包体" tabindex="-1">及时转发包体 <a class="header-anchor" href="#及时转发包体" aria-label="Permalink to &quot;及时转发包体&quot;">​</a></h4><img src="'+Ua+'" style="zoom:80%;"><h4 id="接收上游时网络速度相关指令" tabindex="-1">接收上游时网络速度相关指令 <a class="header-anchor" href="#接收上游时网络速度相关指令" aria-label="Permalink to &quot;接收上游时网络速度相关指令&quot;">​</a></h4><img src="'+La+'" style="zoom:80%;"><h4 id="上游包体的持久化" tabindex="-1">上游包体的持久化 <a class="header-anchor" href="#上游包体的持久化" aria-label="Permalink to &quot;上游包体的持久化&quot;">​</a></h4><img src="'+Oa+`" style="zoom:80%;"><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> listen </span><span style="color:#E1E4E8;">8012;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> default_type </span><span style="color:#E1E4E8;">text/plain;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">html;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/test </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;8012 server resonse.&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">server</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> listen </span><span style="color:#24292E;">8012;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> default_type </span><span style="color:#24292E;">text/plain;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">html;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/test </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">200</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;8012 server resonse.&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-nginx vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">nginx</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">upstream</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">proxyups </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">server</span><span style="color:#E1E4E8;"> 127.0.0.1:8012 </span><span style="color:#FFAB70;">weight</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">server {</span></span>
<span class="line"><span style="color:#E1E4E8;">  listen </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> server_name </span><span style="color:#E1E4E8;">store.yueluo.club;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> error_log </span><span style="color:#E1E4E8;">logs/error.log</span><span style="color:#79B8FF;"> debug</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;"> root </span><span style="color:#E1E4E8;">/tmp;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">location</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">/ </span><span style="color:#E1E4E8;">{</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_pass </span><span style="color:#E1E4E8;">http://proxyups;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_store </span><span style="color:#E1E4E8;">on;</span></span>
<span class="line"><span style="color:#E1E4E8;">   </span><span style="color:#F97583;"> proxy_store_access </span><span style="color:#E1E4E8;">user:rw group:rw all:r;</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">upstream</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">proxyups </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">server</span><span style="color:#24292E;"> 127.0.0.1:8012 </span><span style="color:#E36209;">weight</span><span style="color:#D73A49;">=</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">server {</span></span>
<span class="line"><span style="color:#24292E;">  listen </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> server_name </span><span style="color:#24292E;">store.yueluo.club;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> error_log </span><span style="color:#24292E;">logs/error.log</span><span style="color:#005CC5;"> debug</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;"> root </span><span style="color:#24292E;">/tmp;</span></span>
<span class="line"><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">location</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">/ </span><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_pass </span><span style="color:#24292E;">http://proxyups;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_store </span><span style="color:#24292E;">on;</span></span>
<span class="line"><span style="color:#24292E;">   </span><span style="color:#D73A49;"> proxy_store_access </span><span style="color:#24292E;">user:rw group:rw all:r;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language-js vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">js</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">cur store.yueluo.club tech</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">a.txt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">cur store.yueluo.club tech</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">a.txt</span></span></code></pre></div><h3 id="处理上游的响应头部" tabindex="-1">处理上游的响应头部 <a class="header-anchor" href="#处理上游的响应头部" aria-label="Permalink to &quot;处理上游的响应头部&quot;">​</a></h3><h2 id="五、nginx-系统层性能优化" tabindex="-1">五、Nginx 系统层性能优化 <a class="header-anchor" href="#五、nginx-系统层性能优化" aria-label="Permalink to &quot;五、Nginx 系统层性能优化&quot;">​</a></h2><h2 id="六、深入使用-nginx-与-openresty" tabindex="-1">六、深入使用 Nginx 与 OpenResty <a class="header-anchor" href="#六、深入使用-nginx-与-openresty" aria-label="Permalink to &quot;六、深入使用 Nginx 与 OpenResty&quot;">​</a></h2>`,634),Ma=[Ga];function Wa(Ka,Va,Za,Qa,Ya,Ja){return a(),n("div",null,Ma)}const nn=s(Xa,[["render",Wa]]);export{an as __pageData,nn as default};
